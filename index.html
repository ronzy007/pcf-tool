<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PCF Product Extractor</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #000c19; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  #root { min-height: 100vh; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useCallback, useRef, useMemo } = React;



// â”€â”€â”€ XLSX ZIP PARSER (xlsx files are zip archives containing XML) â”€â”€â”€
async function parseZip(arrayBuffer) {
  const bytes = new Uint8Array(arrayBuffer);
  const files = {};
  
  // Find central directory entries
  let offset = bytes.length - 22;
  while (offset > 0 && !(bytes[offset] === 0x50 && bytes[offset+1] === 0x4b && bytes[offset+2] === 0x05 && bytes[offset+3] === 0x06)) offset--;
  
  const cdOffset = bytes[offset+16] | (bytes[offset+17] << 8) | (bytes[offset+18] << 16) | (bytes[offset+19] << 24);
  const cdCount = bytes[offset+10] | (bytes[offset+11] << 8);
  
  let pos = cdOffset;
  for (let i = 0; i < cdCount && pos < bytes.length - 46; i++) {
    if (bytes[pos] !== 0x50 || bytes[pos+1] !== 0x4b) break;
    const compression = bytes[pos+10] | (bytes[pos+11] << 8);
    const compSize = bytes[pos+20] | (bytes[pos+21] << 8) | (bytes[pos+22] << 16) | (bytes[pos+23] << 24);
    const uncompSize = bytes[pos+24] | (bytes[pos+25] << 8) | (bytes[pos+26] << 16) | (bytes[pos+27] << 24);
    const nameLen = bytes[pos+28] | (bytes[pos+29] << 8);
    const extraLen = bytes[pos+30] | (bytes[pos+31] << 8);
    const commentLen = bytes[pos+32] | (bytes[pos+33] << 8);
    const localOffset = bytes[pos+42] | (bytes[pos+43] << 8) | (bytes[pos+44] << 16) | (bytes[pos+45] << 24);
    
    const name = new TextDecoder().decode(bytes.slice(pos+46, pos+46+nameLen));
    
    // Read local file header to find data start
    const localNameLen = bytes[localOffset+26] | (bytes[localOffset+27] << 8);
    const localExtraLen = bytes[localOffset+28] | (bytes[localOffset+29] << 8);
    const dataStart = localOffset + 30 + localNameLen + localExtraLen;
    
    if (compression === 0) {
      // Stored (no compression)
      files[name] = new TextDecoder().decode(bytes.slice(dataStart, dataStart + uncompSize));
    } else if (compression === 8) {
      // Deflated - use DecompressionStream
      try {
        const compressed = bytes.slice(dataStart, dataStart + compSize);
        const ds = new DecompressionStream("deflate-raw");
        const writer = ds.writable.getWriter();
        writer.write(compressed);
        writer.close();
        const reader = ds.readable.getReader();
        const chunks = [];
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
        }
        const total = chunks.reduce((a, c) => a + c.length, 0);
        const result = new Uint8Array(total);
        let off = 0;
        for (const c of chunks) { result.set(c, off); off += c.length; }
        files[name] = new TextDecoder().decode(result);
      } catch(e) {
        // Skip files that fail to decompress
      }
    }
    
    pos += 46 + nameLen + extraLen + commentLen;
  }
  return files;
}

// â”€â”€â”€ CUSTOMER TERMS DATABASE â”€â”€â”€
const _R=[{"i":"1000527","n":"BSS (SOUTHAMPTON )","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"K"},{"i":"1000524","n":"BSS (READING 18)","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"K"},{"i":"1000511","n":"BSS (LEWES 19)","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"K"},{"i":"1002066","n":"BSS (CRAWLEY 39)","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"K"},{"i":"1000491","n":"BSS (BOURNEMOUTH)","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"A"},{"i":"1003492","n":"BSS (PORTSMOUTH 82)","a":36.0,"b":30.0,"c":31.0,"d":31.0,"e":31.0,"f":28.0,"g":"WHOLESALER","k":"A"},{"i":"472559","n":"PIPE - EASTLEIGH (BT)","a":35.0,"b":29.0,"c":27.0,"d":27.0,"e":27.0,"f":27.0,"g":"WHOLESALER","k":"A"},{"i":"460846","n":"PIPE - POOLE (BW)","a":35.0,"b":29.0,"c":27.0,"d":27.0,"e":27.0,"f":27.0,"g":"WHOLESALER","k":"A"},{"i":"1002281","n":"PIPE - CRAWLEY (G55)","a":35.0,"b":29.0,"c":27.0,"d":27.0,"e":27.0,"f":27.0,"g":"WHOLESALER","k":"B"},{"i":"472672","n":"PIPE - PORTSMOUTH (G5)","a":35.0,"b":29.0,"c":27.0,"d":27.0,"e":27.0,"f":27.0,"g":"WHOLESALER","k":"B"},{"i":"1001816","n":"ACTION PUMPS LTD","a":41.0,"b":34.0,"c":32.0,"d":32.0,"e":32.0,"f":34.0,"g":"WHOLESALER","k":"K"},{"i":"1002122","n":"ACTION PUMPS LTD (OEM)","a":41.0,"b":34.0,"c":32.0,"d":32.0,"e":32.0,"f":34.0,"o":"OEM Terms","g":"OEM","k":"K"},{"i":"9022019466","n":"Design & Build","g":"WHOLESALER"},{"i":"1002191","n":"BSS Wandsworth","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"1002952","n":"BSS Barking","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"1000498","n":"BSS Croydon","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"1000525","n":"BSS Romford","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"1000492","n":"BSS Brentford","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"1001010","n":"Wolseley Kent","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"9022009861","n":"WOLSELEY UK (WGB)","o":"Not my account but use for PCF","g":"WHOLESALER"},{"i":"9024011300","n":"BTS BAUDAINS TRADE SUPPLIES","o":"50% FOR Hospital work ONLY","g":"WHOLESALER","k":"P"},{"i":"9022023904","n":"Giles Heating","a":45.0,"b":27.0,"c":27.0,"f":27.0,"g":"OTHER","k":"B"},{"i":"9022013242","n":"E & B GROUP LTD","a":45.0,"b":45.0,"c":45.0,"f":27.0,"g":"OTHER","k":"C"},{"i":"9022004610","n":"A R B Mechanical Ltd","a":50.0,"b":40.0,"c":45.0,"d":50.0,"e":50.0,"f":30.0,"o":"Boosters Less 50%","g":"INSTALLER","k":"K"},{"i":"9022015432","n":"Corrigenda Engineering Services","a":51.0,"b":40.0,"c":45.0,"d":45.0,"e":45.0,"f":30.0,"o":"Boosters Less 50%","g":"INSTALLER","k":"K"},{"i":"9022003206","n":"J & B Hopkins Ltd","a":50.0,"b":45.0,"c":50.0,"d":50.0,"e":50.0,"f":30.0,"o":"Boosters Less 50%","g":"INSTALLER","k":"K"},{"i":"9022012377","n":"Lowe & Oliver","a":47.0,"b":40.0,"c":45.0,"d":47.0,"e":47.0,"f":30.0,"o":"Boosters Less 50%","g":"INSTALLER","k":"K"},{"i":"9022000881","n":"Paine Manwaring Limited","a":48.0,"b":35.0,"c":40.0,"d":45.0,"e":45.0,"f":30.0,"o":"Booster and PU less 45%","g":"INSTALLER","k":"K"},{"i":"9022007559","n":"T S S Facilities Ltd","a":47.0,"b":35.0,"c":27.0,"f":27.0,"o":"Booster and PU less 45%","g":"INSTALLER","k":"K"},{"i":"9022007196","n":"Working Environments Ltd","a":45.0,"b":45.0,"c":45.0,"f":45.0,"o":"Boosters Less 50%","g":"INSTALLER","k":"K"},{"i":"9022005668","n":"Allflow Pumps & Pump Systems","a":53.0,"b":47.0,"f":35.0,"g":"INSTALLER","k":"K"},{"i":"9022017579","n":"A D Mechanical","a":50.0,"b":40.0,"c":45.0,"d":47.0,"e":47.0,"f":30.0,"o":"Boosters Less 45%","g":"INSTALLER","k":"A"},{"i":"9022014796","n":"Accolade Building Services Ltd","a":47.0,"b":30.0,"c":45.0,"d":47.0,"e":47.0,"f":27.0,"o":"Boosters Less 45%","g":"INSTALLER","k":"A"},{"i":"9022010360","n":"Dixon Mechanical Services Ltd","a":45.0,"b":30.0,"c":30.0,"f":27.0,"o":"Boosters Less 45%","g":"INSTALLER","k":"A"},{"i":"9022014412","n":"Edgar & Wood Mechanical","a":45.0,"o":"Boosters Less 43%","g":"INSTALLER","k":"A"},{"i":"9022007321","n":"EMCOR Engineering - Eastleigh","a":45.0,"b":30.0,"c":30.0,"d":45.0,"e":40.0,"f":27.0,"o":"Boosters Less 45%","g":"INSTALLER","k":"A"},{"i":"9022017979","n":"Enerveo SSE - Chichester","a":47.5,"c":45.0,"g":"INSTALLER","k":"A"},{"i":"9022006217","n":"Enerveo SSE  - Farnborough","a":47.5,"c":45.0,"g":"INSTALLER","k":"A"},{"i":"9022007146","n":"Enerveo SSE - Southampton","a":47.5,"c":45.0,"g":"INSTALLER","k":"A"},{"i":"9022016180","n":"KIER Proc. & Eng. - Basingstoke","a":45.0,"b":33.0,"c":33.0,"f":33.0,"o":"Boosters Less 45%","g":"INSTALLER","k":"A"},{"i":"9022008357","n":"Lorne Stewart - Fareham","g":"INSTALLER","k":"A"},{"i":"9022013654","n":"Megan Mechanical","a":45.0,"b":35.0,"c":45.0,"d":47.0,"e":45.0,"f":28.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"A"},{"i":"9020004477","n":"Megan Renewable Installations Limited","a":45.0,"b":35.0,"c":45.0,"d":47.0,"e":45.0,"f":28.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"A"},{"i":"9022024862","n":"Mitie","a":50.0,"b":40.0,"c":45.0,"f":40.0,"g":"INSTALLER","k":"A"},{"i":"9022026140","n":"Promep Ltd","a":45.0,"g":"INSTALLER","k":"A"},{"i":"9022004243","n":"Rossair Ltd","a":47.0,"b":30.0,"c":30.0,"f":27.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"A"},{"i":"9022017757","n":"S M S Southern Limited","a":45.0,"b":30.0,"c":30.0,"f":30.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"A"},{"i":"9022006296","n":"Sale Service & Maintenance","a":45.0,"b":38.0,"c":45.0,"d":47.0,"e":45.0,"f":30.0,"o":"MPCE Less 47%","g":"INSTALLER","k":"A"},{"i":"9022035757","n":"Sale Service & Maintenance (South)","a":45.0,"b":38.0,"c":45.0,"d":47.0,"e":45.0,"f":30.0,"o":"MPCE Less 47%","g":"INSTALLER","k":"B"},{"i":"9022014851","n":"Wessex Building Services Ltd","g":"INSTALLER","k":"A"},{"i":"9022023722","n":"Anchor Maintenance Ltd","a":47.0,"b":35.0,"c":40.0,"d":45.0,"e":45.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"A"},{"i":"9022003010","n":"Rushmoor Mechanical Services","g":"INSTALLER","k":"B"},{"i":"9022028498","n":"D W Electrical Ltd","g":"INSTALLER","k":"B"},{"i":"9022029534","n":"Logic Contract Services Ltd","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022002329","n":"Newcombustion Engineering Ltd","a":43.0,"g":"INSTALLER","k":"B"},{"i":"9022023273","n":"AES M & E Contractors","a":43.0,"g":"INSTALLER","k":"B"},{"i":"9022022603","n":"All Seasons Hire Ltd","a":48.0,"b":30.0,"c":30.0,"d":40.0,"e":33.0,"f":30.0,"o":"Magna 1 and 3 only","g":"INSTALLER","k":"B"},{"i":"9022021228","n":"Aston Services","g":"INSTALLER","k":"B"},{"i":"9022025883","n":"B M Air Ltd","g":"INSTALLER","k":"B"},{"i":"9024019192","n":"Birdsall Services Ltd","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022017851","n":"Borahurst Ltd","a":43.0,"b":35.0,"c":27.0,"d":45.0,"e":40.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022025450","n":"Brady & Gallagher","a":45.0,"b":27.0,"c":45.0,"d":45.0,"e":45.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022017305","n":"Briar Mechanical","a":43.0,"g":"INSTALLER","k":"B"},{"i":"9022023919","n":"Bryair Mechanical Ltd","g":"INSTALLER","k":"B"},{"i":"9980025417      9024015138","n":"BTU (Inst. & Maint.) CBS","a":45.0,"b":35.0,"c":30.0,"d":45.0,"e":40.0,"f":30.0,"g":"INSTALLER","k":"B"},{"i":"9022001645","n":"Buckler Environmental","g":"INSTALLER","k":"B"},{"i":"9022013545","n":"C E I Electrical Ltd","g":"INSTALLER","k":"B"},{"i":"9022026137","n":"Capitol Engineering Services","g":"INSTALLER","k":"B"},{"i":"9022016875","n":"CFES Ltd","g":"INSTALLER","k":"B"},{"i":"9022021213","n":"Challenge Building Services","g":"INSTALLER","k":"B"},{"i":"9022008065","n":"Choiceall","g":"INSTALLER","k":"B"},{"i":"9022025309","n":"CLOSEWOOD AIR CONDITIONING","g":"INSTALLER","k":"B"},{"i":"9022017670","n":"Comfort Building Services Ltd","a":45.0,"b":27.0,"c":27.0,"d":41.0,"e":35.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022015614","n":"Cromwell Engineering","g":"INSTALLER","k":"B"},{"i":"9022025522","n":"D & B Mechanical","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022021273","n":"D P P Ltd","a":45.0,"b":35.0,"c":27.0,"d":43.0,"e":35.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022016529","n":"D S R Mechanical Services Ltd","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022002189","n":"Dewco Limited","g":"INSTALLER","k":"B"},{"i":"9022008248","n":"Dodd Group - Southampton","a":45.0,"b":40.0,"c":45.0,"d":45.0,"e":45.0,"f":30.0,"g":"INSTALLER","k":"B"},{"i":"9022008654","n":"EMCOR Facilities Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022025075","n":"Emico Limited","g":"INSTALLER","k":"B"},{"i":"9022016219","n":"Enviromech Ltd","g":"INSTALLER","k":"B"},{"i":"9022014765","n":"Eurodata Building Services Ltd.","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022011021","n":"F W Marsh Ltd","a":45.0,"b":27.0,"c":27.0,"d":40.0,"e":33.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022012365","n":"Fairways Engineering Co Ltd","a":45.0,"b":35.0,"c":27.0,"d":45.0,"e":40.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022024919","n":"Flow Plumbing Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022029130","n":"FUTURE CONTRACTING M&E","g":"INSTALLER","k":"B"},{"i":"9022010581","n":"G P Plumbing & Heating","a":45.0,"b":30.0,"c":45.0,"d":45.0,"e":45.0,"g":"INSTALLER","k":"B"},{"i":"9022021267","n":"G Tech Building Services","g":"INSTALLER","k":"B"},{"i":"9022008662","n":"Gardner Mechanical Services","a":43.0,"b":27.0,"c":27.0,"d":42.0,"e":35.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022002082","n":"George Brough & Co (London Ltd)","g":"INSTALLER","k":"B"},{"i":"9022025557","n":"Greenside Intergrated Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022013793","n":"H & C Contracts Ltd","g":"INSTALLER","k":"B"},{"i":"9022021749","n":"Honan Building Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022016132","n":"Howard Electrical Ltd","g":"INSTALLER","k":"B"},{"i":"9022001337","n":"Independent heating & Cooling","g":"INSTALLER","k":"B"},{"i":"9022005260","n":"Industrial Boiler Services","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022012001","n":"J W Plumbing & Heating Ltd","a":45.0,"g":"INSTALLER","k":"B"},{"i":"10317","n":"Jackson Plumbing and Heating","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022001759","n":"Kentex Services","a":41.0,"b":40.0,"c":27.0,"d":45.0,"e":35.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022010705","n":"L B S (Logistical Building Services)","a":45.0,"b":30.0,"c":30.0,"d":55.0,"e":50.0,"o":"CAT 3 Boosters Less 55% MPCE - Whitecode design projects.","g":"INSTALLER","k":"B"},{"i":"9022027661","n":"Lewis Services Group Ltd","a":42.0,"g":"INSTALLER","k":"B"},{"i":"9022016886","n":"Linaker Limited","g":"INSTALLER","k":"B"},{"i":"9022023297","n":"LSC Environmental Ltd","g":"INSTALLER","k":"B"},{"i":"9022019721","n":"Marlin Building Services","g":"INSTALLER","k":"B"},{"i":"9022023717","n":"Medway Mechanical Services","g":"INSTALLER","k":"B"},{"i":"9022002981","n":"P J M Mechanical Services Ltd","a":40.0,"b":27.0,"c":27.0,"d":41.0,"e":35.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022015309","n":"Relay Engineering","g":"INSTALLER","k":"B"},{"i":"9022020996","n":"Rentec Ltd","a":45.0,"b":27.0,"c":27.0,"d":40.0,"e":33.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022024795","n":"ROCMEP Limited (Old name: ROC Mechanical)","a":45.0,"b":40.0,"c":40.0,"d":47.0,"e":47.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022001037","n":"Sapphire Mechanical UK Ltd","g":"INSTALLER","k":"B"},{"i":"9022012726","n":"Scion Technical Services","g":"INSTALLER","k":"B"},{"i":"9022004546","n":"Scomac Services Ltd","a":45.0,"b":30.0,"c":30.0,"f":30.0,"o":"Boosters & PU Less 45%","g":"INSTALLER","k":"B"},{"i":"9022018498","n":"Sea Green Contracts Ltd","g":"INSTALLER","k":"B"},{"i":"9022010723","n":"Seaforth Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022027626","n":"ServCom Services UK Ltd","a":42.0,"g":"INSTALLER","k":"B"},{"i":"9022016483","n":"Servio Limited","a":42.0,"g":"INSTALLER","k":"B"},{"i":"9022001486","n":"Sidney Cubbage (H & V) Ltd","a":43.0,"b":28.0,"c":30.0,"d":45.0,"e":45.0,"f":28.0,"g":"INSTALLER","k":"B"},{"i":"9022007940","n":"Simer Environmental Services","a":45.0,"b":38.0,"c":27.0,"d":45.0,"e":41.0,"f":27.0,"o":"50% for Tricel fro CAT 1","g":"INSTALLER","k":"B"},{"i":"9022002413","n":"Southern Pipe Services Ltd.","a":45.0,"c":45.0,"g":"INSTALLER","k":"B"},{"i":"9022022020","n":"SOWGA Ltd","a":45.0,"g":"INSTALLER","k":"B"},{"i":"9022002711","n":"Summit Design Ltd","a":45.0,"b":35.0,"c":35.0,"d":45.0,"e":45.0,"f":27.0,"g":"INSTALLER","k":"B"},{"i":"9022012289","n":"T Squared","a":45.0,"b":30.0,"c":30.0,"f":30.0,"g":"INSTALLER","k":"B"},{"i":"9022004095","n":"T4 Mechanical Services Ltd","a":45.0,"b":30.0,"c":30.0,"f":30.0,"g":"INSTALLER","k":"B"},{"i":"9022003330","n":"Target Site Services Ltd","g":"INSTALLER","k":"B"},{"i":"9022012590","n":"Tugwell Heating Co Ltd","g":"INSTALLER","k":"B"},{"i":"9022021927","n":"United Mechanical Ltd","a":45.0,"b":27.0,"d":40.0,"e":33.0,"g":"INSTALLER","k":"B"},{"i":"9022003049","n":"Vear Building Services Ltd","a":42.0,"g":"INSTALLER","k":"B"},{"i":"9022001381","n":"Wilden Services","g":"INSTALLER","k":"B"},{"i":"9022021273","n":"D P P Ltd","a":45.0,"b":35.0,"d":43.0,"e":35.0,"g":"INSTALLER","k":"B"},{"i":"9022025157","n":"G P Watson","a":45.0,"o":"(note - DPP buy Wilo and Grundfos - and growing - spend in approx 700K in plant) GBAHP - Supported to 45% on Cat 1 with Action Pumps.","g":"INSTALLER","k":"P"},{"i":"9022025507","n":"Baystar Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022029613","n":"FORTH ROYSTON GROUP","a":45.0,"d":43.0,"e":43.0,"g":"INSTALLER","k":"P"},{"i":"9022005807","n":"Heatcraft Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022015296","n":"I D C Mechanical & Electrical","a":45.0,"c":40.0,"g":"INSTALLER","k":"P"},{"i":"9022029210","n":"James Liston Building Services","a":45.0,"c":45.0,"d":40.0,"e":40.0,"g":"INSTALLER","k":"P"},{"i":"9022011223","n":"M J G Mechanical & Electrical","a":47.0,"b":35.0,"c":27.0,"d":45.0,"e":38.0,"g":"INSTALLER","k":"P"},{"i":"9022028760","n":"Optimum Install Ltd","o":"Terms to be assigned","g":"INSTALLER","k":"P"},{"i":"9022026999","n":"Rossair (Retail & Maintenance)","a":45.0,"b":35.0,"c":45.0,"o":"Booster and PU less 45%","g":"INSTALLER","k":"P"},{"i":"9022000805","n":"Saunders Specialised Services","a":45.0,"b":27.0,"c":45.0,"o":"Booster and PU less 45%","g":"INSTALLER","k":"P"},{"i":"9022024374","n":"Touch Building Services Limited","a":45.0,"b":40.0,"c":40.0,"d":45.0,"e":45.0,"o":"Booster and PU less 50%","g":"INSTALLER","k":"P"},{"i":"9022038505","n":"Konextions ltd","a":43.0,"g":"INSTALLER","k":"P"},{"i":"9022038506","n":"J W MECHANICAL LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039230","n":"Alpha Heat Mechanical Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039265","n":"AH Engineers Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022038740","n":"Powerpoint Electrical Contractors Ltd","a":47.0,"g":"INSTALLER","k":"P"},{"i":"9022037770","n":"Shoretech","a":50.0,"g":"INSTALLER","k":"P"},{"i":"9022039295","n":"Enbloc Ltd","a":40.0,"g":"INSTALLER","k":"P"},{"i":"9022040142","n":"Liberty Gas Group","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022037320","n":"COMGAS SERVICES UK Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040226","n":"Cistus Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039522","n":"Wight Heating Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040015","n":"RB Commercial Heating Ltd","a":46.0,"g":"INSTALLER","k":"P"},{"i":"9022038661","n":"Roselands Heating","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039680","n":"Inovolt Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040370","n":"L T Mechanical Solutions Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040371","n":"Plumbing and Heating Services Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022037949","n":"RKEC LTD","a":45.0,"b":40.0,"c":40.0,"d":45.0,"e":45.0,"f":27.0,"g":"INSTALLER","k":"P"},{"i":"9022036882","n":"Danmar Mechanical Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040015","n":"RB Commercial Heating Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040566","n":"Michael Whyte Maintenance Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040567","n":"K.J. Quinn Services Ltd","a":43.0,"g":"INSTALLER","k":"P"},{"i":"9022039528","n":"CH4 Mechanical & Electrical Services Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040566","n":"MICHAEL WHYTE MAINTENANCE LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040579","n":"Raffray Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040581","n":"Crown Heating & Plumbing Ltd","a":40.0,"g":"INSTALLER","k":"P"},{"i":"9022040634","n":"Asbury Heating Maintenance Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022034114","n":"ANTAC SUPPORT SERVICES LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040650","n":"J W Roberts Plumbing & Heating Limited","a":43.0,"g":"INSTALLER","k":"P"},{"i":"9022040654","n":"SMH Plumbing & Heating","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039983","n":"TS Plumbing And Heating Services Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022039972","n":"Marcade Building Services Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040663","n":"Southern Mechanical and Electrical Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040664","n":"Cooper Weston Group Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040719","n":"Airtech Air Conditioning Services Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040731","n":"Industrial Heaters (Southern) Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040738","n":"C.S. Plumbing and Heating Services Ltd","a":40.0,"o":"0.44","g":"INSTALLER","k":"P"},{"i":"9022040431","n":"SOVEREIGN NETWORK GROUP","a":50.0,"o":"50% (BSS Only)","g":"INSTALLER","k":"P"},{"i":"9022040742","n":"Pyramid Services (South) Ltd","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040767","n":"Award Plumbing Limited","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040770","n":"Derham Ball Contracts Limited","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040787","n":"OUR MEP Co.","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040827","n":"Bates Biomass Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040858","n":"Industrial Pipe Systems Limited","g":"INSTALLER","k":"P"},{"i":"9022040860","n":"Orostream International Contracts","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040864","n":"TMI Mechanical Ltd","a":41.0,"g":"INSTALLER","k":"P"},{"i":"9022040865","n":"MAC Energy","a":42.0,"g":"INSTALLER","k":"P"},{"i":"9022040888","n":"Prima ACR Ltd","g":"INSTALLER","k":"P"},{"i":"9022040084","n":"GREEN GATE MECHANICAL SERVICES LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039427","n":"Portsdean Heating Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022040965","n":"Diligent Commercial Services LTD","g":"INSTALLER","k":"P"},{"i":"9022040985","n":"Hi Tech Property Services Ltd","g":"INSTALLER","k":"P"},{"i":"9022040270","n":"NEW HAZE BUILDING SERVICES LIMITED","a":45.0,"o":"Trial - 45","g":"INSTALLER","k":"P"},{"i":"9022041002","n":"Brookside Southern Ltd.","a":43.0,"g":"INSTALLER","k":"P"},{"i":"9022041003","n":"Goodwins Building Services Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039278","n":"Rubon Mechanical Services","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039124","n":"SRT Heating & Gas LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041117","n":"Somervilleâ€™s Ltd","g":"INSTALLER","k":"P"},{"i":"9022041144","n":"Prime Square Services","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041145","n":"D B Green Limited","g":"INSTALLER","k":"P"},{"i":"9022041168","n":"SJM 360 GROUP (UK) LTD","g":"INSTALLER","k":"P"},{"i":"9022039447","n":"Comfort Service & Maintenance Limited","g":"INSTALLER","k":"P"},{"i":"9022041263","n":"South Heat and Electrical Ltd","g":"INSTALLER","k":"P"},{"i":"9022041389","n":"Surrey Plumbing & Heating Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041767","n":"Airtemp AC Ltd","g":"INSTALLER","k":"P"},{"i":"9022041443","n":"1066 PHD Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022039060","n":"Contract Trading Services","g":"INSTALLER","k":"P"},{"i":"9022042299","n":"A Greener Alternative LTD","g":"INSTALLER","k":"P"},{"i":"9980019554","n":"Building Ventilation Solutions","g":"INSTALLER","k":"P"},{"i":"9980020120","n":"Evolve Water Ltd","g":"INSTALLER","k":"P"},{"i":"9980020574","n":"Reed M&E Limited","g":"INSTALLER","k":"P"},{"i":"9022041390","n":"Bioheat Energy Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041391","n":"Bridge Greenhouses Ltd (Southern)","g":"INSTALLER","k":"P"},{"i":"9022041398","n":"Tate Technical Services Limited","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041117","n":"SOMERVILLE'S LTD","g":"INSTALLER","k":"P"},{"i":"9022040431","n":"SOVEREIGN NETWORK GROUP","g":"INSTALLER","k":"P"},{"i":"9022041420","n":"Paul Earl Limited","g":"INSTALLER","k":"P"},{"i":"9022041474","n":"Xpert Installations Ltd","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022041786","n":"HeatWave Mechanical Services Ltd","g":"INSTALLER","k":"P"},{"i":"9022041882","n":"DCI Refrigeration & Electrical Limited","g":"INSTALLER","k":"P"},{"i":"9980012549","n":"Naked Energy Ltd","g":"INSTALLER","k":"P"},{"i":"9980021639","n":"BB Heat Pumps Ltd","g":"INSTALLER","k":"P"},{"i":"9980021662","n":"Coastal Mechanical Services Ltd","g":"INSTALLER","k":"P"},{"i":"9980022181","n":"Tredion Group Ltd.","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9980025844","n":"Bradbury Electrical Contractors Ltd","g":"INSTALLER","k":"P"},{"i":"9980025846","n":"PSC Global","g":"INSTALLER","k":"P"},{"i":"9980048168","n":"Wessex ME Wessex Group","a":53.0,"g":"INSTALLER","k":"P"},{"i":"9980024397","n":"TARNWALK (UK) LTD","a":45.0,"g":"INSTALLER","k":"P"},{"i":"9022005168","n":"A C Mechanical Services","g":"INSTALLER","k":"C"},{"i":"9022022955","n":"AES Maintenance Ltd","g":"INSTALLER","k":"C"},{"i":"9022029767","n":"AIR CONDITIONING CENCEPTS LTD","g":"INSTALLER","k":"C"},{"i":"9022029054","n":"Alan Finch Gas Services","g":"INSTALLER","k":"C"},{"i":"9022026590","n":"Amarville Project Services","g":"INSTALLER","k":"C"},{"i":"9022029241","n":"APL","g":"INSTALLER","k":"C"},{"i":"9022028824","n":"Arcforce","g":"INSTALLER","k":"C"},{"i":"9022025013","n":"Aspect First Ltd","g":"INSTALLER","k":"C"},{"i":"9022014259","n":"Atmosair Limited","g":"INSTALLER","k":"C"},{"i":"9022019638","n":"B B S UK Heating","g":"INSTALLER","k":"C"},{"i":"9022021827","n":"B R Biddle","g":"INSTALLER","k":"C"},{"i":"9022026174","n":"Blue Water Mech. & Elec.","g":"INSTALLER","k":"C"},{"i":"9022026375","n":"Cedar Green Projects Limited","g":"INSTALLER","k":"C"},{"i":"9022006782","n":"Clarkes Mechanical Limited","a":45.0,"b":27.0,"c":27.0,"d":40.0,"e":33.0,"f":27.0,"g":"INSTALLER","k":"C"},{"i":"9022023043","n":"DesignHeat Winchester Ltd","g":"INSTALLER","k":"C"},{"i":"9022026959","n":"Evans & Graham Group","g":"INSTALLER","k":"C"},{"i":"9022026425","n":"Gatwick Park Mech. Services","g":"INSTALLER","k":"C"},{"i":"9022011820","n":"Guilfram Heating Company Ltd","g":"INSTALLER","k":"C"},{"i":"9022020781","n":"Industrial Siteworks Ltd","g":"INSTALLER","k":"C"},{"i":"9022028863","n":"J C Mechanical Estimating Ltd","g":"INSTALLER","k":"C"},{"i":"9022021145","n":"J F K Plumbing & Heating","g":"INSTALLER","k":"C"},{"i":"9022022279","n":"John Warrener Ltd","g":"INSTALLER","k":"C"},{"i":"9022025909","n":"KMECH Services Limited","g":"INSTALLER","k":"C"},{"i":"9022005414","n":"Landmarc Support Services","g":"INSTALLER","k":"C"},{"i":"9022033733","n":"LONDON & SURREY CONTRACTORS","a":42.0,"g":"INSTALLER","k":"C"},{"i":"9022018961","n":"M Allum Plumbing & Heating","g":"INSTALLER","k":"C"},{"i":"9022025348","n":"Mastercool","g":"INSTALLER","k":"C"},{"i":"9022026791","n":"Maximum Air Conditioning Ltd","g":"INSTALLER","k":"C"},{"i":"9022034751","n":"MERRELL MECHANICAL","g":"INSTALLER","k":"C"},{"i":"9022021491","n":"P J S Mech & Elec Building Services","g":"INSTALLER","k":"C"},{"i":"9022011352","n":"SCL Building Services Engineers","g":"INSTALLER","k":"C"},{"i":"9022016443","n":"Scott Combustion","a":45.0,"g":"INSTALLER","k":"C"},{"i":"9022026259","n":"UK South Services","g":"INSTALLER","k":"C"},{"i":"9022040358","n":"Glenhurst Mechanical Services Ltd","g":"INSTALLER","k":"C"},{"i":"9022015486","n":"KIER Facilitiy Serv. - Basingstoke","a":45.0,"b":33.0,"c":33.0,"d":45.0,"e":35.0,"f":33.0,"g":"F M","k":"A"},{"i":"9022033792","n":"FME INTEGRATED UNIT 7","g":"F M","k":"B"},{"i":"9022024982","n":"G4S Secure Solutions","g":"F M","k":"C"},{"i":"9022036029","n":"OUR HOSPITAL PROJECT","g":"END USER","k":"K"},{"i":"9022010788","n":"Southampton General Hospital","a":45.0,"b":40.0,"c":40.0,"d":45.0,"e":45.0,"f":27.0,"g":"END USER","k":"K"},{"i":"9022036195","n":"NHS SOLENT TRUST","g":"END USER","k":"A"},{"i":"9024008384","n":"University Of Surrey","a":45.0,"g":"END USER","k":"A"},{"i":"9022001634","n":"Brighton General Hospital","g":"END USER","k":"B"},{"i":"9022013578","n":"Conquest Hospital NHS ESTATES","a":45.0,"g":"END USER","k":"B"},{"i":"9022001602","n":"Southampton City Council","a":45.0,"g":"END USER","k":"B"},{"i":"9022006312","n":"University of Southampton","a":45.0,"g":"END USER","k":"B"},{"i":"9022007643","n":"West Sussex County Council","g":"END USER","k":"B"},{"i":"9024015552","n":"NATIONAL OCEANOGRAPHY CENTRE","g":"END USER","k":"P"},{"i":"9022033794","n":"PRINCESS ELIZABETH HOSPITAL","a":50.0,"g":"END USER","k":"P"},{"i":"9022040720","n":"Goodwood Estate Co. Limited","a":42.0,"g":"END USER","k":"P"},{"i":"9022041130","n":"University of Reading Estates","a":43.0,"g":"END USER","k":"P"},{"i":"9022041239","n":"University Hospitals Dorset NHS FDN","a":45.0,"g":"END USER","k":"P"},{"i":"9022016170","n":"Ardingly College","g":"END USER","k":"C"},{"i":"9022036090","n":"BOURNEMOUTH & POOLE COLLEGE","g":"END USER","k":"C"},{"i":"9022040658","n":"HM Prison La Moye","a":45.0,"g":"END USER","k":"C"},{"i":"9022020880","n":"Enerveo SSE Enterprise - Reading","g":"CONTRACTOR","k":"A"},{"i":"9022019335","n":"I S O Energy Ltd","a":50.0,"d":50.0,"e":50.0,"g":"CONTRACTOR","k":"A"},{"i":"9022034196","n":"JERSEY GENERAL HOSPITAL","g":"CONTRACTOR","k":"A"},{"i":"9022027529","n":"Working Environments","g":"CONTRACTOR","k":"A"},{"i":"9022034554","n":"2TECK LTD","a":45.0,"b":35.0,"c":30.0,"d":45.0,"e":40.0,"f":30.0,"o":"(CAT 1 for Tricel - 45%)","g":"CONTRACTOR","k":"B"},{"i":"9022030171","n":"A & S PLUMBING AND HEATING","g":"CONTRACTOR","k":"B"},{"i":"9022028958","n":"Aircon Installations","g":"CONTRACTOR","k":"B"},{"i":"9022028232","n":"Alpine Works Limited","a":45.0,"b":35.0,"c":40.0,"d":45.0,"e":45.0,"f":30.0,"g":"CONTRACTOR","k":"B"},{"i":"9022034711","n":"AS MECHANICAL & ELECTRICAL LTD","g":"CONTRACTOR","k":"B"},{"i":"9022034405","n":"CALSTAN M&E","a":45.0,"g":"CONTRACTOR","k":"B"},{"i":"9022034216","n":"CAMPBELL WEST MECHANICAL","a":43.0,"o":"Boosters - 45%","g":"CONTRACTOR","k":"B"},{"i":"9022029768","n":"EXTRACAIR INTALLATIONS","g":"CONTRACTOR","k":"B"},{"i":"9022034491","n":"HEVENTA LTD","a":42.0,"g":"CONTRACTOR","k":"B"},{"i":"9022034783","n":"Home And Industrial Group","a":45.0,"g":"CONTRACTOR","k":"B"},{"i":"9022030256","n":"KJG","a":47.0,"o":"Aggred 50% for 10 Orders for MKG","g":"CONTRACTOR","k":"B"},{"i":"9022030054","n":"PRIORITY ENGINEERING","a":45.0,"b":28.0,"c":40.0,"d":45.0,"e":45.0,"f":28.0,"g":"CONTRACTOR","k":"B"},{"i":"9022033796","n":"REFCO LTD","g":"CONTRACTOR","k":"B"},{"i":"9022036030","n":"ROK GROUP","g":"CONTRACTOR","k":"B"},{"i":"9022034624","n":"T & K ELECTRICALS LTD","a":50.0,"b":40.0,"c":45.0,"d":47.0,"e":47.0,"f":35.0,"g":"CONTRACTOR","k":"B"},{"i":"9022034379","n":"TREVOR JONES CONTRACTING","g":"CONTRACTOR","k":"B"},{"i":"9022028182","n":"Zero Carbon Solutions Ltd","g":"CONTRACTOR","k":"B"},{"i":"9022036231","n":"360 ENGINEERING THE CHAPEL","g":"CONTRACTOR","k":"P"},{"i":"9022037997","n":"A.R.T. Alternative Renewable Technologie","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035239","n":"ADVANCED CONTROL SOLUTIONS","a":45.0,"o":"Use this for ADVANCED MAINTENANCE","g":"CONTRACTOR","k":"P"},{"i":"9022034194","n":"AK CONTROLS LTD","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022029109","n":"Atalan Mechanical Services","g":"CONTRACTOR","k":"P"},{"i":"9022034212","n":"HEATHLANDS HEATING SERVICES","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035279","n":"I-SERV MECHANICAL LIMITED","a":42.0,"g":"CONTRACTOR","k":"P"},{"i":"9022030180","n":"PCB TECHNICAL SOLUTIONS LTD","g":"CONTRACTOR","k":"P"},{"i":"9022026011","n":"Slic Mechanical","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035327","n":"BARLOWS Barlows Retail","a":44.0,"b":28.0,"c":30.0,"d":43.0,"e":40.0,"f":28.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035735","n":"CALMEC FERNDOWN IND EST","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035232","n":"CONCEPT BUILDING SERVICES","a":47.0,"b":37.0,"c":45.0,"d":47.0,"e":47.0,"f":37.0,"g":"CONTRACTOR","k":"P"},{"i":"9022030231","n":"Correct Contract Services CCS","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022038589","n":"Gateway Building Services","g":"CONTRACTOR","k":"P"},{"i":"9022035848","n":"HENRY CONSTRUCTION PROJECTS","g":"CONTRACTOR","k":"P"},{"i":"9022036000","n":"HYGIENIC & ENVIRONMENTAL","g":"CONTRACTOR","k":"P"},{"i":"9022034588","n":"HYTHE BUILDING SERVICES","g":"CONTRACTOR","k":"P"},{"i":"9022036222","n":"INSTALL PROJECTS","g":"CONTRACTOR","k":"P"},{"i":"9022037321","n":"J Ashwell Ltd","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022036264","n":"JAMIESONS SERVICES LTD","g":"CONTRACTOR","k":"P"},{"i":"9022035012","n":"MACE MECHANICAL LTD","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022033679","n":"MITIE TECH FACILITIES","g":"CONTRACTOR","k":"P"},{"i":"9022036515","n":"RENDESCO LIMITED","g":"CONTRACTOR","k":"P"},{"i":"9022029651","n":"RJC (MECHANICAL) LTD","a":50.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035061","n":"T. A BOXALL & CO LTD","g":"CONTRACTOR","k":"P"},{"i":"9022036486","n":"TRYGAR ENGINEERING","a":45.0,"g":"CONTRACTOR","k":"P"},{"i":"9022035086","n":"ZEPHYR ENGINEERING","a":45.0,"b":35.0,"c":35.0,"d":45.0,"e":45.0,"f":27.0,"g":"CONTRACTOR","k":"P"},{"i":"9022040659","n":"Meridian Cooling Ltd","a":41.0,"g":"CONTRACTOR","k":"P"},{"i":"9022040822","n":"JB Associates","g":"CONTRACTOR","k":"P"},{"i":"9980030458","n":"EMTEC SOUTHERN LIMITED","g":"CONTRACTOR","k":"P"},{"i":"9022034010","n":"AB GROUP","g":"CONTRACTOR","k":"C"},{"i":"9022035863","n":"AFOS GROUP","g":"CONTRACTOR","k":"C"},{"i":"9022033846","n":"BRIAN D SMITH","g":"CONTRACTOR","k":"C"},{"i":"9022036121","n":"C J BURFIELD","g":"CONTRACTOR","k":"C"},{"i":"9022033816","n":"D Martin Welding Ltd","g":"CONTRACTOR","k":"C"},{"i":"9022029579","n":"D W SMITH SERVICES","a":42.0,"o":"Using this A/C. for DDP","g":"CONTRACTOR","k":"C"},{"i":"9022035691","n":"DRAPER HEAT LTD","o":"Using this A/C. for Drummond (43%)","g":"CONTRACTOR","k":"C"},{"i":"9022035084","n":"DS MECHACNICAL","a":45.0,"g":"CONTRACTOR","k":"C"},{"i":"9022027993","n":"EMCOR UK","g":"CONTRACTOR","k":"C"},{"i":"9022035418","n":"EPH LTD","a":45.0,"g":"CONTRACTOR","k":"C"},{"i":"9022034705","n":"F.G.B BUILDING SVS LIMITED","a":45.0,"g":"CONTRACTOR","k":"C"},{"i":"9022033635","n":"HAMPSHIRE HOSPITALS FOUNDATION","a":45.0,"g":"CONTRACTOR","k":"C"},{"i":"9022029791","n":"HUGHES GROUP LTD","o":"Use this for HBS","g":"CONTRACTOR","k":"C"},{"i":"9022034501","n":"HYDRO HEATING SOLUTIONS","g":"CONTRACTOR","k":"C"},{"i":"9022030033","n":"ISS FM VELOCITY","g":"CONTRACTOR","k":"C"},{"i":"9022035508","n":"JOHN HANNANT","g":"CONTRACTOR","k":"C"},{"i":"9022035769","n":"M AND T MECH SERVICES LTD","g":"CONTRACTOR","k":"C"},{"i":"9022035137","n":"MACHINE TOOL & ENGINEERING","g":"CONTRACTOR","k":"C"},{"i":"9022030038","n":"MIDAS GROUP","g":"CONTRACTOR","k":"C"},{"i":"9022035718","n":"NIGEL SPRIGGS","g":"CONTRACTOR","k":"C"},{"i":"9022026071","n":"Parcar Ltd","g":"CONTRACTOR","k":"C"},{"i":"9022002748","n":"Hoare Lea - Bournemouth (07)","g":"CONSULTANT","k":"K"},{"i":"9022014681","n":"R H B Partnership - Hampshire","g":"CONSULTANT","k":"K"},{"i":"9022018101","n":"Ramboll UK Ltd","g":"CONSULTANT","k":"K"},{"i":"9022010653","n":"WSP - Parsons Brinckerhoff","g":"CONSULTANT","k":"K"},{"i":"9022003482","n":"WSP Parsons Brinckerhoff Ltd - Surrey","g":"CONSULTANT","k":"K"},{"i":"9022017362","n":"A M A Consulting Engineers Ltd","g":"CONSULTANT","k":"A"},{"i":"9022016206","n":"Hampshire County Council","g":"CONSULTANT","k":"A"},{"i":"9022000627","n":"Hampshire County Council - Property","g":"CONSULTANT","k":"A"},{"i":"9022021473","n":"Hamson Barron Smith Partnership","g":"CONSULTANT","k":"A"},{"i":"9022010443","n":"Ian White Associates","g":"CONSULTANT","k":"A"},{"i":"9022020993","n":"K C S Consulting Limited","g":"CONSULTANT","k":"A"},{"i":"9022012372","n":"Pope Building Services","g":"CONSULTANT","k":"A"},{"i":"9022010879","n":"TNG Consulting Engineers","g":"CONSULTANT","k":"A"},{"i":"9022027425","n":"Westec Engineering Ltd","g":"CONSULTANT","k":"A"},{"i":"9022026551","n":"Contractors Design Partner","g":"CONSULTANT","k":"A"},{"i":"9022022424","n":"Cooper Homewood Ltd","g":"CONSULTANT","k":"A"},{"i":"9022022840","n":"Delta Green Environmental Design Ltd","g":"CONSULTANT","k":"A"},{"i":"9022017754","n":"I T D Consultants","g":"CONSULTANT","k":"A"},{"i":"9022027132","n":"ION Consulting Engineers Ltd","g":"CONSULTANT","k":"A"},{"i":"9022010974","n":"Mabey Francis & Partners","g":"CONSULTANT","k":"A"},{"i":"9022005940","n":"Martin Thomas Associates - MTA","g":"CONSULTANT","k":"A"},{"i":"9022026095","n":"Ridge and Partners LLP","g":"CONSULTANT","k":"A"},{"i":"9022021829","n":"T H D Consulting Engineers","g":"CONSULTANT","k":"A"},{"i":"9022029310","n":"EDP-ENVIRONMENTAL","g":"CONSULTANT","k":"A"},{"i":"9022002023","n":"Hannaford Upright","g":"CONSULTANT","k":"A"},{"i":"9022029733","n":"MKP Consultants","g":"CONSULTANT","k":"A"},{"i":"9022028961","n":"SALVIS ENERGY SERVICES LTD","g":"CONSULTANT","k":"A"},{"i":"9022025867","n":"Seraphic Consulting Ltd","g":"CONSULTANT","k":"A"},{"i":"9022036011","n":"THERMAL ENVIRONMENT DESIGNS LTD","g":"CONSULTANT","k":"A"},{"i":"9980027383","n":"Arup - Winchester","g":"CONSULTANT","k":"A"},{"i":"9022034813","n":"FVB DISTRICT ENERGY UK LTD","g":"CONSULTANT","k":"A"},{"i":"9022011332","n":"M K P Consultants","g":"CONSULTANT","k":"B"},{"i":"9022015892","n":"Graham Powell Consultants","g":"CONSULTANT","k":"B"},{"i":"9022007265","n":"Milieu Consult","g":"CONSULTANT","k":"B"},{"i":"9022006553","n":"Blair Rains M & E Design","g":"CONSULTANT","k":"B"},{"i":"9022010983","n":"Brighton & Hove City Council","g":"CONSULTANT","k":"B"},{"i":"9022000539","n":"Capita","g":"CONSULTANT","k":"B"},{"i":"9022024131","n":"Carnell Warren Associates Ltd","g":"CONSULTANT","k":"B"},{"i":"9022027740","n":"Channel Design Consultants Guernsey","g":"CONSULTANT","k":"B"},{"i":"9022014024","n":"David Webb Associates","g":"CONSULTANT","k":"B"},{"i":"9022022844","n":"East Sussex Partnership NHS Trust","g":"CONSULTANT","k":"B"},{"i":"9022034744","n":"GAS CONSULTANCY SERVICES LTD","g":"CONSULTANT","k":"B"},{"i":"9022035312","n":"GLJ DESIGN SERVICES LIMITED","g":"CONSULTANT","k":"B"},{"i":"9022026567","n":"Henderson Green Partnership","g":"CONSULTANT","k":"B"},{"i":"9022033817","n":"IJMDESIGN (UK) LTD","g":"CONSULTANT","k":"B"},{"i":"9022027128","n":"Ingenium Consulting Engineers Ltd","g":"CONSULTANT","k":"B"},{"i":"9022001657","n":"Inspire Consulting UK Ltd","g":"CONSULTANT","k":"B"},{"i":"9022006823","n":"Johnathan Hart Associates","g":"CONSULTANT","k":"B"},{"i":"9022008163","n":"Jon Draper Associates (JDA)","g":"CONSULTANT","k":"B"},{"i":"9022012148","n":"M C A Consulting Engineers Ltd - Fa","g":"CONSULTANT","k":"B"},{"i":"9022034556","n":"McANDREW MARTIN","g":"CONSULTANT","k":"B"},{"i":"9022004760","n":"McCarthy Bainbridge Ltd","g":"CONSULTANT","k":"B"},{"i":"9022008494","n":"McLellan & Partners","g":"CONSULTANT","k":"B"},{"i":"9022008397","n":"P J R Design Services Ltd","g":"CONSULTANT","k":"B"},{"i":"9022006073","n":"Portsmouth City Council","g":"CONSULTANT","k":"B"},{"i":"9022020385","n":"Power Plan Solutions LLP","g":"CONSULTANT","k":"B"},{"i":"9022009639","n":"Progressive Design Solutions","g":"CONSULTANT","k":"B"},{"i":"9022033832","n":"PROSPERO PROJECTS LTD","g":"CONSULTANT","k":"B"},{"i":"9022025539","n":"PWA Designs Ltd","g":"CONSULTANT","k":"B"},{"i":"9022035282","n":"RITCHIE+DAFFIN STUDIO D","g":"CONSULTANT","k":"B"},{"i":"9022036474","n":"SSE ENERGY SOLUTIONS","g":"CONSULTANT","k":"B"},{"i":"9022001979","n":"Surrey County Council","g":"CONSULTANT","k":"B"},{"i":"9022034591","n":"TAZINDA","g":"CONSULTANT","k":"B"},{"i":"9022035733","n":"THE DESIGN COLLECTIVE","g":"CONSULTANT","k":"B"},{"i":"9022014696","n":"Woking Borough Council CBS","g":"CONSULTANT","k":"B"},{"i":"9022022969","n":"Worldwise Limited Building Services","g":"CONSULTANT","k":"B"},{"i":"9022029215","n":"Patterson Reeves & Partners","g":"CONSULTANT","k":"B"},{"i":"9022039234","n":"JVS Associates Ltd","g":"CONSULTANT","k":"P"},{"i":"9022040869","n":"AMF Mech Ltd","g":"CONSULTANT","k":"P"},{"i":"9022040913","n":"MaitlandQS Limited","g":"CONSULTANT","k":"P"},{"i":"9022041176","n":"Tournay Godfrey Ltd","g":"CONSULTANT","k":"P"},{"i":"9022041179","n":"Arcadis (Guildford)","g":"CONSULTANT","k":"P"},{"i":"9022041419","n":"En Masse Design Ltd","g":"CONSULTANT","k":"P"},{"i":"9022041405","n":"PARRISH CONSULTING LTD","g":"CONSULTANT","k":"P"},{"i":"9022041785","n":"Mesh Energy Limited","g":"CONSULTANT","k":"P"},{"i":"9022041881","n":"D10 Consulting LTD","g":"CONSULTANT","k":"P"},{"i":"9980012636","n":"Atkins RÃ©alis","g":"CONSULTANT","k":"P"},{"i":"9980041454","n":"Futura Bright Limited","g":"CONSULTANT","k":"P"},{"i":"9022012513","n":"C B S Design Consultants","g":"CONSULTANT","k":"C"},{"i":"9022027691","n":"C R Underhay & Partners Ltd","g":"CONSULTANT","k":"C"},{"i":"9022006313","n":"E E P (Environmental Engineering Pa","g":"CONSULTANT","k":"C"},{"i":"9022026538","n":"Freeman Beesley Ltd","g":"CONSULTANT","k":"C"},{"i":"9022010625","n":"Harley Haddow Partnership","g":"CONSULTANT","k":"C"},{"i":"9022001642","n":"M F D International Ltd","g":"CONSULTANT","k":"C"},{"i":"9022035371","n":"MARTIN ASHLEY ARCHITECTS","g":"CONSULTANT","k":"C"},{"i":"9022000625","n":"Mott MacDonald Group - Brighton","g":"CONSULTANT","k":"C"},{"i":"9022034156","n":"OAKLEY M&E DESIGN LTD","g":"CONSULTANT","k":"C"},{"i":"9022018095","n":"Promode Building Services Consultan","g":"CONSULTANT","k":"C"}];
const CUSTOMER_TERMS_RAW=_R.map(r=>({id:r.i,name:r.n,g1:r.a,g2:r.b,g3:r.c,g3b_mpce:r.d,g3b_multi:r.e,g4:r.f,other:r.o,group:r.g||"",cls:r.k||""})); // mutable array for upload updates

// â”€â”€â”€ PROMPTS â”€â”€â”€
const EXTRACTION_PROMPT = `You are a strict data extraction engine for Grundfos product orders.

TASK: From the supplied order document (PDF or image), extract ALL Grundfos products and return structured JSON.

RULES:
1. Extract products with these Grundfos Product ID formats:
   - 8-digit codes starting with "9" (e.g. 97924463, 99104652, 98406627, 92513956)
   - Grundfos codes typically start with: 99, 98, 97, 96, 95 (8-digit numeric) e.g. 99221305, 98301408, 97924338
   - Alpha-prefix codes like MD300200, CR10-02, UP15-14, SE1.50, CM3-3, TP32-80, UPS25-80, GBPS0099 etc.
   - These may appear as the BSS "Product Code" column, within the "Description" column, OR on a separate line below the main product line
   - A Grundfos code may be embedded in description text (e.g. "Kit, Control box cpl. BBAA 98406627" â†’ extract 98406627, or "98301408 CIM 500 ETHERNET ADD-ON CPL." â†’ extract 98301408)
   - On multi-line orders, check ALL lines including continuation/sub-lines for Grundfos codes
2. IGNORE BSS-only product codes (starting with 80, 83, 53, 22, 07, 84, 15, 90 etc.) that have NO Grundfos code anywhere on the same line or adjacent description lines
3. If a BSS code and Grundfos code appear on the same line or in the same product block, extract ONLY the Grundfos code as product_id. The Grundfos code is usually in the Description column (e.g. BSS code 80430863 with description "98301408 CIM 500..." â†’ extract 98301408)
4. If the Grundfos code is in the Description (e.g. "MD300200 HOME BOOSTER 3.0 BAR"), extract "MD300200" as product_id and the full text as description
5. Extract: product_id, description, quantity, discount_percent, customer_ref, customer_name, distributor_name
6. For discount: extract numeric value only. "43+" â†’ 43, "45%" â†’ 45, "55/-" â†’ 55, "60% / -" â†’ 60. If no discount shown, use null
7. For customer_ref: extract the reference number using this priority order:
   1st choice: Acknowledgement Number (e.g. "14/39866", "40/22115")
   2nd choice: Order Number if no acknowledgement number exists
   3rd choice: Invoice Number if neither of the above exists
   Extract the COMPLETE number including any prefix (e.g. "14/39866" NOT just "39866", "1400/0345635" NOT just "0345635").
8. For description: extract the product description text shown on the order line
9. For customer_name: extract the customer/company name from the "Deliver To", "Delivered to", or address section of the document. This is the installer or end customer name, NOT the BSS branch.
10. For distributor_name: extract the BSS branch name from the document header, letterhead, or "From" section (e.g. "BSS Portsmouth", "BSS Lewes", "1820 BSS Portsmouth", "BSS (LEWES 19)"). This is the BSS branch that sent the order, NOT the installer.
11. If the image is blurry or hard to read, do your best â€” extract what you can confidently read and skip anything uncertain

Return ONLY valid JSON array, no markdown, no explanation:
[{"product_id":"99221242","description":"MAGNA3 32-120 F","qty":3,"discount":43,"customer_ref":"14/39866","customer_name":"UNITED MECHANICAL LTD","distributor_name":"BSS Portsmouth"},{"product_id":"98301408","description":"CIM 500 ETHERNET ADD-ON CPL.","qty":6,"discount":50,"customer_ref":"19/19249","customer_name":"","distributor_name":"BSS Lewes"}]

If no qualifying Grundfos items found, return: []`;

const EMAIL_PROMPT = `You are extracting customer-to-order mappings from an email or message screenshot.

TASK: This image shows an email (or message) that lists which customer (installer) corresponds to which order number. Extract all customer-order pairs AND the sender's first name.

Look for patterns like:
- "Anchor - 40716" â†’ customer "Anchor", order "40716"  
- "Baudains - 42102" â†’ customer "Baudains", order "42102"
- "Rossair 41414" â†’ customer "Rossair", order "41414"
- "UHS - 45604" â†’ customer "UHS", order "45604"
- "Installation design - 43390" â†’ customer "Installation design", order "43390"

The order numbers are usually 5-digit numbers. The customer name comes before the number, separated by a dash, space, or similar.

Also extract the sender's FIRST NAME from the email signature, "From" field, or sign-off (e.g. "Regards, David Gentry" â†’ "David", "Rebecca Moore" â†’ "Rebecca").

Return ONLY valid JSON object (not array), no markdown, no explanation:
{"sender_name":"David","mappings":[{"customer":"Anchor","order_ref":"40716"},{"customer":"Baudains","order_ref":"42102"}]}

If no mappings found, return: {"sender_name":"","mappings":[]}`;

const SUPPORTED_TYPES = {
  "application/pdf": "document",
  "image/png": "image", "image/jpeg": "image", "image/jpg": "image",
  "image/webp": "image", "image/gif": "image", "image/bmp": "image", "image/tiff": "image",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": "spreadsheet",
  "application/vnd.ms-excel": "spreadsheet",
  "text/plain": "text",
};

const ACCEPTED_EXTENSIONS = [".pdf", ".png", ".jpg", ".jpeg", ".webp", ".gif", ".bmp", ".tiff", ".tif", ".xlsx", ".xls", ".txt"];

function getFileType(file) {
  if (file.type && SUPPORTED_TYPES[file.type]) return file.type;
  const ext = file.name.toLowerCase().split(".").pop();
  const mimeMap = {
    pdf: "application/pdf", png: "image/png", jpg: "image/jpeg",
    jpeg: "image/jpeg", webp: "image/webp", gif: "image/gif",
    bmp: "image/bmp", tiff: "image/tiff", tif: "image/tiff",
    xlsx: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    xls: "application/vnd.ms-excel",
    txt: "text/plain",
  };
  return mimeMap[ext] || null;
}

function getContentType(mimeType) { return SUPPORTED_TYPES[mimeType] || null; }

function getFileIcon(file) {
  const mime = getFileType(file);
  if (!mime) return "ðŸ“Ž";
  if (mime === "application/pdf") return "ðŸ“„";
  if (mime === "text/plain") return "ðŸ“";
  if (getContentType(mime) === "spreadsheet") return "ðŸ“Š";
  return "ðŸ–¼ï¸";
}

// â”€â”€â”€ CUSTOMER MATCHING â”€â”€â”€
function findCustomer(name) {
  if (!name) return null;
  const lower = name.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
  if (!lower) return null;

  // Exact ID match
  const byId = CUSTOMER_TERMS_RAW.find(c => c.id === name.trim());
  if (byId) return byId;

  // Common/noise words that shouldn't drive matching
  const noise = new Set(["ltd","limited","the","and","for","services","service","group","uk","co","plc","inc"]);

  // Score all candidates
  const scored = [];
  for (const c of CUSTOMER_TERMS_RAW) {
    const cLower = c.name.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
    const cWords = cLower.split(/\s+/);
    const qWords = lower.split(/\s+/);
    let score = 0;

    // Exact full match
    if (cLower === lower) { score = 100; }
    // DB name starts with search term
    else if (cLower.startsWith(lower + " ") || cLower.startsWith(lower)) { score = 80 + (lower.length / cLower.length) * 15; }
    // Search starts with DB name (e.g. "RB Commercial Heating and Electrical Ltd" starts with "RB Commercial Heating")
    else if (lower.startsWith(cLower + " ") || lower.startsWith(cLower)) { score = 78 + (cLower.length / lower.length) * 15; }
    // First word of DB name matches first word of search
    else if (cWords[0] === qWords[0] && qWords[0].length >= 3) { score = 70 + (qWords[0].length / cLower.length) * 10; }
    // Search term is contained in DB name
    else if (cLower.includes(lower)) { score = 60; }
    // Word overlap scoring â€” with noise word filtering
    else {
      let matched = 0, significantMatched = 0;
      const qSignificant = qWords.filter(w => w.length >= 3 && !noise.has(w));
      const cSignificant = cWords.filter(w => w.length >= 3 && !noise.has(w));
      for (const w of qSignificant) {
        if (cSignificant.some(cw => cw === w)) { matched += 2; significantMatched++; }
        else if (cSignificant.some(cw => cw.startsWith(w) || w.startsWith(cw))) { matched += 1; significantMatched++; }
      }
      if (matched > 0) {
        // Scale by proportion of significant words matched in BOTH query and candidate
        const qCoverage = qSignificant.length > 0 ? significantMatched / qSignificant.length : 0;
        const cCoverage = cSignificant.length > 0 ? significantMatched / cSignificant.length : 0;
        score = Math.min(55, matched * 12) + (qCoverage + cCoverage) * 10;
      }
    }

    if (score > 0) scored.push({ customer: c, score });
  }

  scored.sort((a, b) => b.score - a.score);
  return scored.length > 0 && scored[0].score >= 30 ? scored[0].customer : null;
}

function getDiscountGroups(customer) {
  if (!customer) return {};
  const groups = {};
  if (customer.g1 != null) groups["CAT 1"] = customer.g1;
  if (customer.g2 != null) groups["CAT 2"] = customer.g2;
  if (customer.g3 != null) groups["CAT 3"] = customer.g3;
  if (customer.g3b_mpce != null) groups["CAT 3B - MPCE"] = customer.g3b_mpce;
  if (customer.g3b_multi != null) groups["CAT 3B - Multi E"] = customer.g3b_multi;
  if (customer.g4 != null) groups["CAT 4"] = customer.g4;
  return groups;
}

function validateDiscount(extractedDiscount, customer) {
  if (extractedDiscount === "" || extractedDiscount == null) {
    if (customer) {
      const groups = getDiscountGroups(customer);
      const vals = Object.values(groups);
      if (vals.length > 0) {
        return { status: "missing_with_terms", msg: "No discount â€” select from terms" };
      }
    }
    return { status: "missing", msg: "No discount on order" };
  }
  if (!customer) return { status: "no_terms", msg: "Customer not in terms" };
  const disc = Number(extractedDiscount);
  const groups = getDiscountGroups(customer);
  const vals = Object.values(groups);
  if (vals.length === 0) return { status: "no_terms", msg: "No terms set up" };
  if (vals.includes(disc)) {
    const gk = Object.keys(groups).find(k => groups[k] === disc);
    return { status: "match", msg: `âœ“ Matches ${gk} (${disc}%)` };
  }
  const closest = vals.reduce((a, b) => Math.abs(b - disc) < Math.abs(a - disc) ? b : a);
  const ck = Object.keys(groups).find(k => groups[k] === closest);
  return { status: "mismatch", msg: `${disc}% â‰  agreed. Nearest: ${ck} (${closest}%)` };
}

// â”€â”€â”€ MAIN COMPONENT â”€â”€â”€
function PCFTool() {
  const [activeTab, setActiveTab] = useState("extract"); // "extract" | "terms"
  const [orderFiles, setOrderFiles] = useState([]);
  const [emailFile, setEmailFile] = useState(null);
  const [extractedData, setExtractedData] = useState([]);
  const [customerMap, setCustomerMap] = useState({}); // orderRef â†’ {customer name, matched customer obj}
  const [processing, setProcessing] = useState(false);
  const [progressMsg, setProgressMsg] = useState("");
  const [error, setError] = useState(null);
  const [editingCell, setEditingCell] = useState(null);
  const [logs, setLogs] = useState([]);
  const [showLogs, setShowLogs] = useState(false);
  const [customerSearch, setCustomerSearch] = useState("");
  const [showPicker, setShowPicker] = useState(false);
  const [pickerTarget, setPickerTarget] = useState(null); // null or rowIdx for per-row assignment
  const [discountChoices, setDiscountChoices] = useState({}); // rowIdx â†’ "order" | "terms" | number
  const [csvReady, setCsvReady] = useState(null); // holds CSV string when generated
  const [generatedEmail, setGeneratedEmail] = useState(null);
  const [replyName, setReplyName] = useState(""); // contact name for email reply
  const [aiInstructions, setAiInstructions] = useState(""); // extra context for AI extraction
  const [apiKey] = useState(() => {
    const _k = "BF0ZyEFTpVVLRRlbJFkejd2SyUnMGRTdIJkTZdmbRBHWGdUTlZ2bo90Rmt0TVN0byEUQZ9FbTdFdpd0ZRxmQKNGZLJUbYBzcMZFcJxWZwdmYWdXawUlWSNWZ280ZYRULzATawFWL05WYts2c";
    return atob(_k.split("").reverse().join(""));
  });
  const [apiCost, setApiCost] = useState({ calls: 0, inputTokens: 0, outputTokens: 0 }); // cost tracker
  const [showSetAllDiscount, setShowSetAllDiscount] = useState(false); // inline discount input
  const [termsSearch, setTermsSearch] = useState("");
  const [termsVersion, setTermsVersion] = useState(0); // bump to force re-render after upload
  const [termsFilter, setTermsFilter] = useState("all"); // "all" | "with_terms" | "no_terms" | group names
  const orderInputRef = useRef(null);
  const emailInputRef = useRef(null);
  const logsEndRef = useRef(null);
  const searchInputRef = useRef(null);

  const addLog = useCallback((msg) => {
    setLogs(prev => {
      const next = [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`];
      setTimeout(() => logsEndRef.current?.scrollIntoView({ behavior: "smooth" }), 50);
      return next;
    });
  }, []);

  const trackUsage = useCallback((apiData) => {
    const usage = apiData?.usage;
    if (usage) {
      const inp = usage.input_tokens || 0;
      const out = usage.output_tokens || 0;
      setApiCost(prev => ({
        calls: prev.calls + 1,
        inputTokens: prev.inputTokens + inp,
        outputTokens: prev.outputTokens + out,
      }));
    }
  }, []);

  // Global paste handler â€” Ctrl+V with image â†’ email screenshot
  React.useEffect(() => {
    const handlePaste = (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith("image/")) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            // Rename with timestamp for clarity
            const named = new File([file], `Screenshot ${new Date().toISOString().slice(0,16).replace("T"," ")}.png`, { type: file.type });
            setEmailFile(named);
          }
          return;
        }
      }
    };
    document.addEventListener("paste", handlePaste);
    return () => document.removeEventListener("paste", handlePaste);
  }, []);

  const filteredCustomers = useMemo(() => {
    if (!customerSearch || customerSearch.length < 2) return [];
    const q = customerSearch.toLowerCase();
    return CUSTOMER_TERMS_RAW.filter(c =>
      c.name.toLowerCase().includes(q) || c.id.includes(customerSearch)
    ).slice(0, 10);
  }, [customerSearch]);

  // Terms page: filtered & searched customer list
  const termsResults = useMemo(() => {
    let list = [...CUSTOMER_TERMS_RAW];
    // Search filter
    if (termsSearch.length >= 1) {
      const q = termsSearch.toLowerCase();
      list = list.filter(c => c.name.toLowerCase().includes(q) || c.id.includes(termsSearch));
    }
    // Group filter
    if (termsFilter === "with_terms") {
      list = list.filter(c => {
        const g = getDiscountGroups(c);
        return Object.keys(g).length > 0;
      });
    } else if (termsFilter === "no_terms") {
      list = list.filter(c => {
        const g = getDiscountGroups(c);
        return Object.keys(g).length === 0;
      });
    } else if (termsFilter !== "all") {
      const keyMap = { "CAT 1": "g1", "CAT 2": "g2", "CAT 3": "g3", "CAT 3B - MPCE": "g3b_mpce", "CAT 3B - Multi E": "g3b_multi", "CAT 4": "g4" };
      const field = keyMap[termsFilter];
      if (field) list = list.filter(c => c[field] != null);
      else if (["INSTALLER", "WHOLESALER", "OTHER", "OEM", "CONTRACTOR", "CONSULTANT", "END USER", "F M"].includes(termsFilter)) {
        list = list.filter(c => c.group === termsFilter);
      }
    }
    return list;
  }, [termsSearch, termsFilter, termsVersion]);

  // â”€â”€â”€ FILE HANDLERS â”€â”€â”€
  const handleOrderFiles = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    const incoming = Array.from(e.dataTransfer?.files || e.target.files || []);
    const valid = [];
    incoming.forEach(f => {
      const mime = getFileType(f);
      if (mime && getContentType(mime)) valid.push(f);
    });
    if (valid.length > 0) setOrderFiles(prev => [...prev, ...valid]);
    if (orderInputRef.current) orderInputRef.current.value = "";
  }, []);

  const handleEmailFile = useCallback((e) => {
    const f = (e.target.files || [])[0];
    if (f) {
      const mime = getFileType(f);
      if (mime && getContentType(mime) === "image") {
        setEmailFile(f);
      } else {
        setError("Email screenshot must be an image (PNG, JPG, etc.)");
      }
    }
    if (emailInputRef.current) emailInputRef.current.value = "";
  }, []);

  const removeOrderFile = (i) => setOrderFiles(prev => prev.filter((_, idx) => idx !== i));

  const clearAll = () => {
    setOrderFiles([]); setEmailFile(null); setExtractedData([]); setCustomerMap({});
    setLogs([]); setError(null); setProcessing(false); setProgressMsg("");
    setDiscountChoices({}); setCsvReady(null); setGeneratedEmail(null);
    setApiCost({ calls: 0, inputTokens: 0, outputTokens: 0 });
  };

  const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = () => reject(new Error("Failed to read file"));
    reader.readAsDataURL(file);
  });

  // â”€â”€â”€ PROCESS â”€â”€â”€
  const processFiles = async () => {
    if (orderFiles.length === 0) return;
    setProcessing(true);
    setError(null);
    setLogs([]);
    setDiscountChoices({});
    setApiCost({ calls: 0, inputTokens: 0, outputTokens: 0 });
    addLog(`Starting extraction for ${orderFiles.length} order file(s)${emailFile ? " + email screenshot" : ""}...`);

    let emailMappings = {};

    // Step 1: Process email screenshot if provided
    if (emailFile) {
      setProgressMsg("Reading email screenshot...");
      addLog("Processing email screenshot for customer mappings...");
      try {
        const b64 = await readFileAsBase64(emailFile);
        const mime = getFileType(emailFile);
        const resp = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 2000,
            messages: [{ role: "user", content: [
              { type: "image", source: { type: "base64", media_type: mime, data: b64 } },
              { type: "text", text: EMAIL_PROMPT }
            ]}]
          })
        });
        if (resp.ok) {
          const data = await resp.json(); trackUsage(data);
          const text = data.content?.map(b => b.type === "text" ? b.text : "").join("") || "";
          try {
            const parsed = JSON.parse(text.replace(/```json|```/g, "").trim());
            // Handle new format: {sender_name, mappings: [...]} or old format: [...]
            const mappings = Array.isArray(parsed) ? parsed : (parsed.mappings || []);
            const senderName = parsed.sender_name || "";
            
            if (senderName) {
              setReplyName(senderName);
              addLog(`  âœ“ Sender: ${senderName}`);
            }
            
            mappings.forEach(m => {
                if (m.customer && m.order_ref) {
                  const ref = String(m.order_ref).trim();
                  const cust = findCustomer(m.customer);
                  emailMappings[ref] = {
                    name: m.customer,
                    matched: cust
                  };
                  addLog(`  âœ“ Mapped: order ${ref} â†’ ${m.customer}${cust ? ` (found: ${cust.name})` : " (not in terms)"}`);
                }
              });
          } catch (e) {
            addLog(`  âš  Could not parse email mappings: ${e.message}`);
          }
        } else {
          addLog(`  âœ— Email API error: ${resp.status}`);
        }
      } catch (err) {
        addLog(`  âœ— Email processing error: ${err.message}`);
      }
    }

    setCustomerMap(emailMappings);

    // Step 2: Process order documents
    let allItems = [];

    for (let i = 0; i < orderFiles.length; i++) {
      const file = orderFiles[i];
      const mimeType = getFileType(file);
      if (!mimeType) { addLog(`âœ— Skipping: ${file.name}`); continue; }

      const contentType = getContentType(mimeType);
      setProgressMsg(`Processing ${i + 1}/${orderFiles.length}: ${file.name}`);

      // â”€â”€â”€ EXCEL FILES: convert to text, then send to API â”€â”€â”€
      if (contentType === "spreadsheet") {
        addLog(`Processing [Excel]: ${file.name}`);
        try {
          const arrayBuffer = await file.arrayBuffer();
          addLog(`  Parsing spreadsheet in browser...`);
          
          const zip = await parseZip(arrayBuffer);
          const sheetXml = zip["xl/worksheets/sheet1.xml"] || "";
          const stringsXml = zip["xl/sharedStrings.xml"] || "";
          
          if (!sheetXml) throw new Error("Could not read sheet data from xlsx");
          
          // Parse shared strings table
          const strings = [];
          const ssMatches = stringsXml.matchAll(/<t[^>]*>([^<]*)<\/t>/g);
          for (const m of ssMatches) strings.push(m[1]);
          
          // Parse sheet rows
          const rowMatches = sheetXml.matchAll(/<row[^>]*>(.*?)<\/row>/gs);
          const rows = [];
          for (const rm of rowMatches) {
            const cells = [];
            // Match each <c> element â€” attributes can be in any order
            const cellMatches = rm[1].matchAll(/<c\s([^>]*)>([^]*?)<\/c>/g);
            for (const cm of cellMatches) {
              const attrs = cm[1];
              const inner = cm[2];
              // Extract column letter from r="A1" etc
              const rMatch = attrs.match(/r="([A-Z]+)\d+"/);
              if (!rMatch) continue;
              const col = rMatch[1];
              // Check if type is shared string
              const isString = /t="s"/.test(attrs);
              // Extract value
              const vMatch = inner.match(/<v>([^<]*)<\/v>/);
              const rawVal = vMatch ? vMatch[1] : "";
              
              if (isString && rawVal) {
                cells.push({ col, val: strings[parseInt(rawVal)] || rawVal });
              } else {
                cells.push({ col, val: rawVal });
              }
            }
            rows.push(cells);
          }
          
          if (rows.length < 2) throw new Error("No data rows found in spreadsheet");
          addLog(`  Found ${rows.length - 1} data rows`);
          
          // Find header row â€” may not be row 0 (could be row 1+ if title rows exist)
          let headerRowIdx = 0;
          const headerKeywords = ["product", "quantity", "discount", "acc", "branch", "contractor", "code", "description", "customer", "order", "invoice", "date", "name", "ref"];
          for (let ri = 0; ri < Math.min(rows.length, 5); ri++) {
            const vals = rows[ri].map(c => String(c.val).toLowerCase());
            const matches = vals.filter(v => headerKeywords.some(k => v.includes(k))).length;
            if (matches >= 2) { headerRowIdx = ri; break; }
          }
          
          // Parse headers from detected header row
          const headers = {};
          rows[headerRowIdx].forEach(c => { headers[c.col] = c.val; });
          addLog(`  Headers: ${Object.values(headers).filter(Boolean).join(", ")}`);
          
          // Universal column mapping â€” match by keyword patterns
          const colMap = {};
          for (const [col, hdr] of Object.entries(headers)) {
            const h = String(hdr).toLowerCase().replace(/[_\s]+/g, "");
            // Product ID / Code columns
            if (!colMap.productCode && (h === "productcode" || h === "product" || h === "partnumber" || h === "partno" || h === "itemcode" || h === "sku" || h === "materialcode")) colMap.productCode = col;
            // Product Description
            if (!colMap.desc && (h.includes("productdescription") || h === "description" || h === "itemdescription" || h === "productname")) colMap.desc = col;
            // Quantity
            if (!colMap.qty && (h.includes("quantity") || h === "qty" || h === "orderedqty")) colMap.qty = col;
            // Discount
            if (!colMap.discount && (h === "discount" || h.includes("itemdiscount") || h.includes("discountpercent") || h.includes("discount%"))) colMap.discount = col;
            // Customer / Account / Contractor name
            if (!colMap.acc && (h.includes("accname") || h === "contractor" || h === "customername" || h === "customer" || h === "account" || h === "accountname" || h === "company" || h === "installer")) colMap.acc = col;
            // Branch / Distributor
            if (!colMap.branch && (h.includes("despatchingbranchname") || h === "branch" || h.includes("branchname") || h === "distributor" || h === "warehouse"|| h === "depot")) colMap.branch = col;
            if (!colMap.branch && h.includes("despatchingbranch")) colMap.branch = col;
            // Reference / Order number
            if (!colMap.custRef && (h.includes("customerordernumber") || h.includes("orderref") || h.includes("customerref") || h.includes("reference") || h.includes("custorderref") || h.includes("quotation"))) colMap.custRef = col;
            if (!colMap.bssRef && (h.includes("bssordernumber") || h.includes("ordernumber") || h.includes("acknowledgement"))) colMap.bssRef = col;
            // Dates
            if (!colMap.despDate && (h.includes("despatchdate") || h.includes("deliverydate") || h.includes("shipdate"))) colMap.despDate = col;
            if (!colMap.invDate && (h.includes("invoicedate") || h.includes("datesubmitted") || h.includes("orderdate"))) colMap.invDate = col;
            // Gross sales (for filtering negative/zero)
            if (!colMap.gross && (h.includes("grosssales") || h.includes("grossprice") || h.includes("netsales") || h.includes("value") || h.includes("amount"))) colMap.gross = col;
            // PAG for spares filtering
            if (!colMap.pag && h.includes("pagname")) colMap.pag = col;
            // Project name
            if (!colMap.project && (h.includes("projectname") || h === "project" || h === "jobname" || h === "sitename")) colMap.project = col;
          }
          
          // Detect if this has BSS-style description (product code embedded in desc) vs direct product code column
          const hasBSSDesc = colMap.desc && !colMap.productCode;
          addLog(`  Format: ${hasBSSDesc ? "BSS (product code in description)" : "Direct product code column"}`);

          // Helper: get short month + year from Excel date serial
          const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          const getMonthYear = (dateVal) => {
            if (!dateVal) return null;
            const num = Number(dateVal);
            if (num > 40000) {
              const d = new Date((num - 25569) * 86400000);
              return { month: months[d.getMonth()], year: String(d.getFullYear()).slice(-2) };
            }
            return null;
          };
          // Primary: get month+year from filename (e.g. "Jan 26", "Jan_26", "January 2026")
          const fnMonths = {"jan":"Jan","feb":"Feb","mar":"Mar","apr":"Apr","may":"May","jun":"Jun","jul":"Jul","aug":"Aug","sep":"Sep","oct":"Oct","nov":"Nov","dec":"Dec"};
          let fileMonth = null, fileYear = null;
          const fnLower = file.name.toLowerCase();
          for (const [k, v] of Object.entries(fnMonths)) {
            if (fnLower.includes(k)) { fileMonth = v; break; }
          }
          // Extract year near month: "Jan 26", "Jan_26", "Jan 2026", "January_2026"
          if (fileMonth) {
            const yrMatch = fnLower.match(new RegExp(fileMonth.toLowerCase() + "[a-z]*[\\s_\\-]*(\\d{2,4})"));
            if (yrMatch) {
              fileYear = yrMatch[1].length === 4 ? yrMatch[1].slice(-2) : yrMatch[1];
            }
          }
          // Fallback: use current date year
          if (!fileYear) {
            fileYear = String(new Date().getFullYear()).slice(-2);
          }

          // Helper: shorten customer name for ref
          const shortenName = (name) => {
            if (!name) return "";
            // Remove common suffixes
            let s = name.replace(/\b(ltd|limited|plc|inc|svcs?|services?|specialised|mechanical|engineering|group|co|and|electrical|heating)\b\.?/gi, "").trim();
            // Take first meaningful word(s), max ~20 chars
            s = s.replace(/\s+/g, " ").trim();
            if (s.length > 20) s = s.split(/\s+/).slice(0, 2).join(" ");
            return s.replace(/[,.\s]+$/, "").trim().toUpperCase();
          };
          
          const items = [];
          let skippedSpares = 0, skippedNegative = 0;
          
          for (let i = headerRowIdx + 1; i < rows.length; i++) {
            const cellMap = {};
            rows[i].forEach(c => { cellMap[c.col] = c.val; });
            
            // â”€â”€â”€ Extract product ID â”€â”€â”€
            let pid = "";
            if (colMap.productCode) {
              // Direct product code column
              pid = String(cellMap[colMap.productCode] || "").trim();
            }
            if (!pid && colMap.desc) {
              // BSS-style: product code embedded in description (first token)
              const desc = String(cellMap[colMap.desc] || "").trim();
              const parts = desc.split(/\s+/);
              if (parts[0] && (/^9\d{7}$/.test(parts[0]) || /^[A-Z]{2,4}\d/.test(parts[0]))) pid = parts[0];
            }
            // Validate: must be Grundfos code pattern
            if (!pid || (!/^9\d{7}$/.test(pid) && !/^[A-Z]{2,4}\d/.test(pid))) continue;
            
            // â”€â”€â”€ Quantity â”€â”€â”€
            const qty = Math.abs(Number(cellMap[colMap.qty] || 1)) || 1;
            
            // â”€â”€â”€ Discount â”€â”€â”€
            let discount = null;
            if (colMap.discount) {
              const rawDisc = cellMap[colMap.discount];
              if (rawDisc !== undefined && rawDisc !== "") {
                const dNum = Number(rawDisc);
                if (!isNaN(dNum)) {
                  // Auto-detect: 0.45 â†’ 45%, 45 â†’ 45%
                  discount = (dNum > 0 && dNum < 1) ? Math.round(dNum * 100) : dNum;
                }
              }
            }
            
            // â”€â”€â”€ Gross sales filter (skip negatives if column exists) â”€â”€â”€
            if (colMap.gross) {
              const gross = Number(cellMap[colMap.gross] || 0);
              if (gross <= 0) { skippedNegative++; continue; }
            }
            
            // â”€â”€â”€ PAG spares filter â”€â”€â”€
            if (colMap.pag) {
              const pagName = String(cellMap[colMap.pag] || "");
              if (pagName.toLowerCase().includes("spares") || pagName.toLowerCase().includes("ancillaries")) { skippedSpares++; continue; }
            }
            
            // â”€â”€â”€ Customer / Account name â”€â”€â”€
            const accName = String(cellMap[colMap.acc] || "").trim();
            
            // â”€â”€â”€ Description â”€â”€â”€
            const desc = colMap.desc ? String(cellMap[colMap.desc] || "").replace(pid, "").trim() : "";
            const project = colMap.project ? String(cellMap[colMap.project] || "").trim() : "";
            const description = desc || project || "";
            
            // â”€â”€â”€ Branch / Distributor â”€â”€â”€
            const branchName = colMap.branch ? String(cellMap[colMap.branch] || "").trim() : "";
            
            // â”€â”€â”€ Reference â”€â”€â”€
            const custRef = colMap.custRef ? String(cellMap[colMap.custRef] || "").trim() : "";
            const bssRef = colMap.bssRef ? String(cellMap[colMap.bssRef] || "").trim() : "";
            
            // â”€â”€â”€ Build REF field â”€â”€â”€
            let month = fileMonth || "";
            let year = fileYear || "";
            if (!month) {
              const dateInfo = getMonthYear(cellMap[colMap.despDate]) || getMonthYear(cellMap[colMap.invDate]);
              if (dateInfo) { month = dateInfo.month; year = year || dateInfo.year; }
            }
            const monthYear = month && year ? `${month} ${year}` : month || "";
            const shortName = shortenName(accName);
            let excelRef = custRef || bssRef || "";
            if (!excelRef) {
              if (project && shortName) excelRef = `${shortenName(project)} - ${shortName}`;
              else if (monthYear && shortName) excelRef = `${monthYear} - ${shortName}`;
              else excelRef = shortName || "";
            }
            
            items.push({
              product_id: pid,
              description,
              qty,
              discount,
              customer_ref: excelRef,
              customer_name: accName,
              distributor_name: branchName,
              _source: file.name,
            });
          }
          
          allItems = [...allItems, ...items];
          addLog(`  âœ“ Extracted ${items.length} Grundfos product(s)`);
          if (skippedSpares > 0) addLog(`  âŠ˜ Skipped ${skippedSpares} spares/ancillaries`);
          if (skippedNegative > 0) addLog(`  âŠ˜ Skipped ${skippedNegative} negative/zero gross value`);
        } catch (err) {
          addLog(`  âœ— Excel error: ${err.message}`);
        }
        continue;
      }

      // â”€â”€â”€ TEXT FILES: read content and send as text prompt â”€â”€â”€
      if (contentType === "text") {
        addLog(`Processing [Text]: ${file.name}`);
        try {
          const textContent = await file.text();
          addLog(`  Sending text to AI for extraction...`);
          const fullTextPrompt = aiInstructions ? EXTRACTION_PROMPT + "\n\nADDITIONAL INSTRUCTIONS FROM USER:\n" + aiInstructions : EXTRACTION_PROMPT;

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 4000,
              messages: [{ role: "user", content: fullTextPrompt + "\n\nHere is the order document text:\n\n" + textContent }]
            })
          });

          if (!response.ok) {
            addLog(`  âœ— API error (${response.status})`);
          } else {
            const data = await response.json(); trackUsage(data);
            const respText = data.content?.map(b => b.type === "text" ? b.text : "").join("") || "";
            try {
              const items = JSON.parse(respText.replace(/```json|```/g, "").trim());
              if (Array.isArray(items)) {
                if (items.length === 0) {
                  addLog(`  âš  Got 0 items, retrying...`);
                  const r2 = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
                    body: JSON.stringify({
                      model: "claude-sonnet-4-20250514",
                      max_tokens: 4000,
                      messages: [{ role: "user", content: fullTextPrompt + "\n\nHere is the order document text:\n\n" + textContent }]
                    })
                  });
                  if (r2.ok) {
                    const d2 = await r2.json(); trackUsage(d2);
                    const t2 = d2.content?.map(b => b.type === "text" ? b.text : "").join("") || "";
                    try {
                      const ri = JSON.parse(t2.replace(/```json|```/g, "").trim());
                      if (Array.isArray(ri) && ri.length > 0) {
                        ri.forEach(item => item._source = file.name);
                        allItems = [...allItems, ...ri];
                        addLog(`  âœ“ Retry extracted ${ri.length} Grundfos item(s)`);
                      } else { addLog(`  âš  Retry also found 0 items`); }
                    } catch(e) { addLog(`  âš  Retry parse error`); }
                  }
                } else {
                  items.forEach(item => item._source = file.name);
                  allItems = [...allItems, ...items];
                  addLog(`  âœ“ Extracted ${items.length} Grundfos item(s)`);
                }
              }
            } catch (parseErr) {
              addLog(`  âš  Parse error: ${parseErr.message}`);
            }
          }
        } catch (err) {
          addLog(`  âœ— Text error: ${err.message}`);
        }
        continue;
      }

      // â”€â”€â”€ PDF / IMAGE FILES: send to API â”€â”€â”€
      const typeLabel = contentType === "document" ? "PDF" : "Image";
      addLog(`Processing [${typeLabel}]: ${file.name}`);

      try {
        const base64Data = await readFileAsBase64(file);
        addLog(`  Sending as ${typeLabel.toLowerCase()}...`);

        const fullPrompt = aiInstructions ? EXTRACTION_PROMPT + "\n\nADDITIONAL INSTRUCTIONS FROM USER:\n" + aiInstructions : EXTRACTION_PROMPT;

        const msgContent = contentType === "document"
          ? [{ type: "document", source: { type: "base64", media_type: mimeType, data: base64Data } }, { type: "text", text: fullPrompt }]
          : [{ type: "image", source: { type: "base64", media_type: mimeType, data: base64Data } }, { type: "text", text: fullPrompt }];

        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 4000,
            messages: [{ role: "user", content: msgContent }]
          })
        });

        if (!response.ok) {
          addLog(`âœ— API error (${response.status})`);
          continue;
        }

        const data = await response.json(); trackUsage(data);
        const textContent = data.content?.map(b => b.type === "text" ? b.text : "").join("") || "";

        try {
          const items = JSON.parse(textContent.replace(/```json|```/g, "").trim());
          if (Array.isArray(items)) {
            if (items.length === 0) {
              // Retry once if nothing extracted â€” LLMs can occasionally miss content
              addLog(`  âš  Got 0 items, retrying...`);
              const retryResponse = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 4000,
                  messages: [{ role: "user", content: msgContent }]
                })
              });
              if (retryResponse.ok) {
                const retryData = await retryResponse.json(); trackUsage(retryData);
                const retryText = retryData.content?.map(b => b.type === "text" ? b.text : "").join("") || "";
                try {
                  const retryItems = JSON.parse(retryText.replace(/```json|```/g, "").trim());
                  if (Array.isArray(retryItems) && retryItems.length > 0) {
                    retryItems.forEach(item => item._source = file.name);
                    allItems = [...allItems, ...retryItems];
                    addLog(`  âœ“ Retry extracted ${retryItems.length} Grundfos item(s)`);
                  } else {
                    addLog(`  âš  Retry also found 0 items â€” may contain no Grundfos products`);
                  }
                } catch(e) { addLog(`  âš  Retry parse error`); }
              }
            } else {
              items.forEach(item => item._source = file.name);
              allItems = [...allItems, ...items];
              addLog(`  âœ“ Extracted ${items.length} Grundfos item(s)`);
            }
          }
        } catch (parseErr) {
          addLog(`  âš  Parse error: ${parseErr.message}`);
          addLog(`  Raw response: ${textContent.slice(0, 100)}`);
        }
      } catch (err) {
        addLog(`âœ— Error: ${err.message}`);
      }
    }

    // Step 3: Validate and build table
    const validated = allItems.filter(item => {
      const id = String(item.product_id);
      const valid = /^9\d{7}$/.test(id) || /^[A-Z]{2,4}\d/.test(id);
      if (!valid) addLog(`âš  Filtered invalid ID: ${id}`);
      return valid;
    });

    const numbered = validated.map((item, idx) => {
      const ref = item.customer_ref || "";
      // Try to match order ref to email mapping
      const refNum = ref.replace(/.*\//, "").trim(); // "14/39866" â†’ "39866"
      const mapping = emailMappings[refNum] || emailMappings[ref] || null;

      // Also try direct customer name match (e.g. from Excel files)
      const excelCustomerName = item.customer_name || "";
      const directMatch = excelCustomerName ? findCustomer(excelCustomerName) : null;

      // Also try distributor match
      const distName = item.distributor_name || "";
      const distMatch = distName ? findCustomer(distName) : null;

      return {
        itemNo: (idx + 1) * 10,
        customerRef: ref,
        productId: String(item.product_id),
        description: item.description || "",
        qty: Number(item.qty) || 1,
        discount: item.discount != null ? Number(item.discount) : "",
        source: item._source,
        customerName: mapping?.name || excelCustomerName || "",
        matchedCustomer: mapping?.matched || directMatch || null,
        distributorName: distName,
        matchedDistributor: distMatch || null,
      };
    });

    setExtractedData(numbered);
    setProgressMsg("");
    addLog(`\nâ”â”â” COMPLETE: ${numbered.length} valid items from ${orderFiles.length} file(s) â”â”â”`);
    
    // Auto-apply AI instructions discount if specified
    if (aiInstructions) {
      const discMatch = aiInstructions.toLowerCase().match(/(\d+(?:\.\d+)?)\s*%/);
      if (discMatch) {
        const disc = Number(discMatch[1]);
        const autoChoices = {};
        numbered.forEach((_, i) => { autoChoices[i] = disc; });
        setDiscountChoices(autoChoices);
        addLog(`âœ“ Auto-applied: ${disc}% discount from AI instructions`);
      }
    }
    
    setProcessing(false);
    setShowLogs(true);
  };

  // â”€â”€â”€ TABLE OPERATIONS â”€â”€â”€
  const updateCell = (rowIdx, field, value) => {
    setExtractedData(prev => prev.map((row, i) =>
      i === rowIdx ? { ...row, [field]: field === "qty" ? (Number(value) || 1) : value } : row
    ));
    // If discount is manually edited, clear any previous choice and store as choice
    if (field === "discount") {
      setDiscountChoices(prev => ({ ...prev, [rowIdx]: value === "" ? "" : Number(value) }));
    }
    setEditingCell(null);
  };

  const deleteRow = (rowIdx) => {
    setExtractedData(prev => {
      const updated = prev.filter((_, i) => i !== rowIdx);
      return updated.map((row, i) => ({ ...row, itemNo: (i + 1) * 10 }));
    });
  };

  const addRow = () => {
    setExtractedData(prev => [...prev, {
      itemNo: (prev.length + 1) * 10,
      customerRef: "", productId: "", description: "", qty: 1, discount: "",
      source: "Manual", customerName: "", matchedCustomer: null, distributorName: "", matchedDistributor: null,
    }]);
  };

  const insertRowAt = (idx) => {
    setExtractedData(prev => {
      const newRow = {
        itemNo: 0,
        customerRef: "", productId: "", description: "", qty: 1, discount: "",
        source: "Manual", customerName: "", matchedCustomer: null, distributorName: "", matchedDistributor: null,
      };
      const updated = [...prev.slice(0, idx), newRow, ...prev.slice(idx)];
      // Renumber all rows
      return updated.map((row, i) => ({ ...row, itemNo: (i + 1) * 10 }));
    });
    // Shift discount choices for rows after the insertion point
    setDiscountChoices(prev => {
      const shifted = {};
      for (const [k, v] of Object.entries(prev)) {
        const ki = Number(k);
        if (ki >= idx) shifted[ki + 1] = v;
        else shifted[ki] = v;
      }
      return shifted;
    });
  };

  const assignCustomerToRow = (rowIdx, customer) => {
    setExtractedData(prev => prev.map((row, i) =>
      i === rowIdx ? { ...row, matchedCustomer: customer, customerName: customer.name } : row
    ));
  };

  const applyTermsDiscount = (rowIdx, discountValue) => {
    setDiscountChoices(prev => ({ ...prev, [rowIdx]: discountValue }));
  };

  const getFinalDiscount = (row, idx) => {
    if (discountChoices[idx] !== undefined) return discountChoices[idx];
    return row.discount;
  };

  // â”€â”€â”€ EXPORT â”€â”€â”€
  // Generate tab-separated data matching Product_Bulk_Entry template
  // Columns: A=ID, B=Part Number, C=Unit List Price, D=Quantity, E=Unit, F=Description,
  //          G=Manual Net, H=Manual Discount, I=Item Discount, J=Item GRP, K=Alternative To,
  //          L=Customer Item Reference, M-Y=empty
  const generateExport = async () => {
    if (extractedData.length === 0) return;
    addLog("Generating template data...");

    const rows = extractedData.map((row, idx) => {
      const disc = getFinalDiscount(row, idx);
      // 25 columns matching A-Y in the template
      const cols = [
        "",                          // A: ID
        row.productId,               // B: Part Number
        "",                          // C: Unit List Price
        row.qty,                     // D: Quantity
        "",                          // E: Unit
        row.description,             // F: Description
        "",                          // G: Manual Net
        "",                          // H: Manual Discount
        disc !== "" ? disc : "",     // I: Item Discount
        "",                          // J: Item GRP
        "",                          // K: Alternative To
        row.customerRef,             // L: Customer Item Reference
        "", "", "", "", "", "", "", "", "", "", "", "", "" // M-Y
      ];
      return cols.join("\t");
    });

    const tsv = rows.join("\n");
    setCsvReady(tsv);

    // Try clipboard copy
    let copied = false;
    try {
      await navigator.clipboard.writeText(tsv);
      copied = true;
    } catch(e) {}
    if (!copied) {
      try {
        const ta = document.createElement("textarea");
        ta.value = tsv;
        ta.style.cssText = "position:fixed;left:-9999px;top:-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        copied = true;
      } catch(e) {}
    }
    addLog(copied
      ? "âœ“ Copied! Open Product_Bulk_Entry.xlsx â†’ click cell A6 â†’ Ctrl+V"
      : "âš  Auto-copy blocked â€” click the Copy button below, then paste into A6"
    );
  };

  const copyTable = () => {
    const hdr = "#\tRef\tProduct ID\tDescription\tQty\tDiscount %\tCustomer\tValidation";
    const rows = extractedData.map((r, i) => {
      const disc = getFinalDiscount(r, i);
      const v = validateDiscount(disc, r.matchedCustomer);
      return `${r.itemNo}\t${r.customerRef}\t${r.productId}\t${r.description}\t${r.qty}\t${disc}\t${r.customerName}\t${v.msg}`;
    });
    navigator.clipboard?.writeText([hdr, ...rows].join("\n"));
    addLog("âœ“ Table copied to clipboard");
  };

  // â”€â”€â”€ SUB-COMPONENTS (stable refs â€” not re-created on render) â”€â”€â”€
  const EditableCell = ({ value, rowIdx, field, type = "text", style: extraStyle }) => {
    const isEditing = editingCell === `${rowIdx}-${field}`;
    if (isEditing) {
      return (
        <input
          autoFocus
          defaultValue={value}
          type={type}
          onBlur={(e) => updateCell(rowIdx, field, e.target.value)}
          onKeyDown={(e) => { if (e.key === "Enter") e.target.blur(); if (e.key === "Escape") setEditingCell(null); }}
          style={{
            width: "100%", padding: "3px 6px", borderRadius: "4px",
            border: "1px solid rgba(0,140,255,0.3)", background: "rgba(0,20,40,0.8)",
            color: "#c0ddf0", fontSize: "12px", fontFamily: "inherit", outline: "none",
            ...extraStyle
          }}
        />
      );
    }
    return (
      <div
        onClick={() => setEditingCell(`${rowIdx}-${field}`)}
        style={{
          cursor: "pointer", padding: "3px 6px", borderRadius: "4px",
          minHeight: "22px", color: value === "" || value == null ? "#2e4e68" : "#8ac0e8",
          ...extraStyle
        }}
        onMouseEnter={(e) => e.currentTarget.style.background = "rgba(0,80,150,0.08)"}
        onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}
      >
        {value === "" || value == null ? "â€”" : String(value)}
      </div>
    );
  };

  // â”€â”€â”€ RENDER â”€â”€â”€
  const hasData = extractedData.length > 0;

  return (
    <div style={{
      minHeight: "100vh", background: "linear-gradient(160deg, #010a15 0%, #021525 40%, #011020 100%)",
      padding: "20px", fontFamily: "'Inter', -apple-system, sans-serif", color: "#6a9abb"
    }}>
      <div style={{ maxWidth: "1050px", margin: "0 auto" }}>
        {/* Header */}
        <div style={{
          display: "flex", alignItems: "center", gap: "14px",
          marginBottom: "18px", paddingBottom: "12px",
          borderBottom: "1px solid rgba(0,140,255,0.06)"
        }}>
          <div style={{
            width: "36px", height: "36px", borderRadius: "9px",
            background: "linear-gradient(135deg, #003366, #005a9e)",
            display: "flex", alignItems: "center", justifyContent: "center",
            fontSize: "16px", boxShadow: "0 2px 12px rgba(0,60,120,0.2)"
          }}>âš¡</div>
          <div>
            <div style={{ fontSize: "16px", fontWeight: "700", color: "#8ac0e8", letterSpacing: "-0.3px" }}>
              PCF Product Extractor
            </div>
            <div style={{ fontSize: "11px", color: "#3a6888", marginTop: "1px" }}>
              BSS Orders (PDF / Excel / Screenshot) â†’ SAP CRM Import
            </div>
          </div>
          <div style={{ flex: 1 }} />
          {(orderFiles.length > 0 || hasData) && (
            <button onClick={clearAll} style={{
              padding: "6px 14px", borderRadius: "6px",
              border: "1px solid rgba(255,60,60,0.12)", background: "rgba(255,30,30,0.06)",
              color: "#aa5555", fontSize: "11px", cursor: "pointer"
            }}>Clear All</button>
          )}
        </div>

        {/* Tab Navigation */}
        <div style={{
          display: "flex", gap: "0", marginBottom: "18px",
          borderBottom: "1px solid rgba(0,140,255,0.08)"
        }}>
          {[
            { id: "extract", label: "ðŸ“„ Extract Orders", icon: "" },
            { id: "terms", label: "ðŸ“‹ Customer Terms", icon: "" }
          ].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{
              padding: "10px 22px", fontSize: "12px", fontWeight: "600",
              border: "none", cursor: "pointer",
              background: activeTab === tab.id ? "rgba(0,80,150,0.12)" : "transparent",
              color: activeTab === tab.id ? "#8ac0e8" : "#3a6888",
              borderBottom: activeTab === tab.id ? "2px solid #0088e0" : "2px solid transparent",
              transition: "all 0.15s"
            }}>{tab.label}</button>
          ))}
          <div style={{ flex: 1 }} />
          <span style={{ fontSize: "10px", color: "#2e4e68", alignSelf: "center", paddingRight: "4px" }}>
            {CUSTOMER_TERMS_RAW.length} customers loaded
          </span>
        </div>

        {/* â•â•â•â•â•â•â• EXTRACT TAB â•â•â•â•â•â•â• */}
        {activeTab === "extract" && (<>

        {/* Upload Section â€” two zones side by side */}
        <div style={{ display: "flex", gap: "12px", marginBottom: "14px", flexWrap: "wrap" }}>
          {/* Order Documents */}
          <div style={{ flex: 2, minWidth: "280px" }}>
            <div style={{ fontSize: "10px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: "6px" }}>
              Order Documents (PDFs / Excel / Screenshots)
            </div>
            <div
              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderColor = "rgba(0,140,255,0.3)"; }}
              onDragLeave={(e) => { e.currentTarget.style.borderColor = "rgba(0,140,255,0.08)"; }}
              onDrop={(e) => { e.stopPropagation(); e.currentTarget.style.borderColor = "rgba(0,140,255,0.08)"; handleOrderFiles(e); }}
              onClick={() => orderInputRef.current?.click()}
              style={{
                padding: orderFiles.length > 0 ? "10px 14px" : "24px 14px",
                borderRadius: "10px", textAlign: "center", cursor: "pointer",
                border: "1.5px dashed rgba(0,140,255,0.08)",
                background: "rgba(0,20,40,0.2)", minHeight: "60px"
              }}
            >
              <input ref={orderInputRef} type="file" multiple accept={ACCEPTED_EXTENSIONS.join(",")}
                onChange={handleOrderFiles} style={{ display: "none" }} />
              {orderFiles.length === 0 ? (
                <>
                  <div style={{ fontSize: "20px", marginBottom: "4px", opacity: 0.4 }}>ðŸ“„</div>
                  <div style={{ fontSize: "12px", color: "#5a8aaa" }}>Drop order files or click to browse</div>
                  <div style={{ fontSize: "10px", color: "#2e5070", marginTop: "3px" }}>PDF, TXT, PNG, JPG, Excel (.xlsx) â€¢ Multiple files supported</div>
                </>
              ) : (
                <div style={{ display: "flex", flexWrap: "wrap", gap: "6px", justifyContent: "center" }}>
                  {orderFiles.map((f, i) => (
                    <div key={i} style={{
                      display: "flex", alignItems: "center", gap: "5px",
                      padding: "3px 9px 3px 7px", borderRadius: "6px",
                      background: "rgba(0,40,80,0.25)", border: "1px solid rgba(0,120,200,0.08)",
                      fontSize: "11px", color: "#6a9abb"
                    }}>
                      <span>{getFileIcon(f)}</span>
                      <span style={{ maxWidth: "100px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{f.name}</span>
                      <span onClick={(e) => { e.stopPropagation(); removeOrderFile(i); }}
                        style={{ cursor: "pointer", color: "#4a3030", fontSize: "13px" }}
                        onMouseEnter={(e) => e.target.style.color = "#ff5555"}
                        onMouseLeave={(e) => e.target.style.color = "#4a3030"}>Ã—</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Email Screenshot */}
          <div style={{ flex: 1, minWidth: "200px" }}>
            <div style={{ fontSize: "10px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: "6px" }}>
              Email Screenshot (optional)
            </div>
            <div
              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderColor = "rgba(0,180,100,0.4)"; }}
              onDragLeave={(e) => { e.currentTarget.style.borderColor = emailFile ? "rgba(0,180,100,0.2)" : "rgba(0,140,255,0.08)"; }}
              onDrop={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.style.borderColor = emailFile ? "rgba(0,180,100,0.2)" : "rgba(0,140,255,0.08)"; const f = (e.dataTransfer?.files || [])[0]; if (f) { const mime = getFileType(f); if (mime && getContentType(mime) === "image") { setEmailFile(f); } else { setError("Email screenshot must be an image (PNG, JPG, etc.)"); } } }}
              onClick={() => emailInputRef.current?.click()}
              style={{
                padding: "10px 14px", borderRadius: "10px", textAlign: "center", cursor: "pointer",
                border: `1.5px dashed ${emailFile ? "rgba(0,180,100,0.2)" : "rgba(0,140,255,0.08)"}`,
                background: emailFile ? "rgba(0,60,40,0.15)" : "rgba(0,20,40,0.2)",
                minHeight: "60px", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center"
              }}
            >
              <input ref={emailInputRef} type="file" accept=".png,.jpg,.jpeg,.webp,.gif"
                onChange={handleEmailFile} style={{ display: "none" }} />
              {emailFile ? (
                <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                  <span style={{ color: "#40aa70", fontSize: "14px" }}>âœ“</span>
                  <span style={{ fontSize: "11px", color: "#6aaa8a", maxWidth: "140px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                    {emailFile.name}
                  </span>
                  <span onClick={(e) => { e.stopPropagation(); setEmailFile(null); }}
                    style={{ cursor: "pointer", color: "#4a3030", fontSize: "13px" }}
                    onMouseEnter={(e) => e.target.style.color = "#ff5555"}
                    onMouseLeave={(e) => e.target.style.color = "#4a3030"}>Ã—</span>
                </div>
              ) : (
                <>
                  <div style={{ fontSize: "16px", marginBottom: "3px", opacity: 0.4 }}>ðŸ“§</div>
                  <div style={{ fontSize: "11px", color: "#5a8aaa" }}>Email with customerâ†’order mapping</div>
                  <div style={{ fontSize: "9px", color: "#2e5070", marginTop: "2px" }}>Drop, click, or Ctrl+V to paste screenshot</div>
                </>
              )}
            </div>
          </div>
        </div>

        {/* AI Instructions */}
        <div style={{ marginBottom: "10px" }}>
          <div style={{ fontSize: "10px", fontWeight: "600", color: "#4a7a9e", marginBottom: "4px", textTransform: "uppercase", letterSpacing: "0.5px" }}>
            AI Instructions (optional)
          </div>
          <textarea
            placeholder="Extra context for the AI, e.g. 'Discount is 60% on all items' or 'Installer is Paine Manwaring' or 'Ignore accessories, only extract pumps'"
            value={aiInstructions}
            onChange={(e) => setAiInstructions(e.target.value)}
            style={{
              width: "100%", height: "40px", padding: "6px 10px", borderRadius: "7px",
              border: "1px solid rgba(0,140,255,0.08)", background: "rgba(0,15,30,0.3)",
              color: "#8ac0e8", fontSize: "11px", fontFamily: "'Segoe UI', sans-serif",
              resize: "vertical", outline: "none", lineHeight: "1.5",
              boxSizing: "border-box"
            }}
            onFocus={(e) => { e.target.style.borderColor = "rgba(0,140,255,0.2)"; e.target.style.height = "60px"; }}
            onBlur={(e) => { e.target.style.borderColor = "rgba(0,140,255,0.08)"; if (!e.target.value) e.target.style.height = "40px"; }}
          />
        </div>

        {error && (
          <div style={{
            padding: "8px 14px", borderRadius: "8px", marginBottom: "10px",
            background: "rgba(255,50,50,0.06)", border: "1px solid rgba(255,50,50,0.1)",
            fontSize: "12px", color: "#cc5555"
          }}>{error}</div>
        )}

        {/* Action Bar */}
        <div style={{ display: "flex", alignItems: "center", gap: "10px", marginBottom: "14px", flexWrap: "wrap" }}>
          <button onClick={processFiles} disabled={orderFiles.length === 0 || processing}
            style={{
              padding: "9px 22px", borderRadius: "8px", border: "none",
              background: orderFiles.length > 0 && !processing ? "linear-gradient(135deg, #005a9e, #0088e0)" : "rgba(40,60,80,0.4)",
              color: orderFiles.length > 0 && !processing ? "#fff" : "#4a6a80",
              fontSize: "13px", fontWeight: "600",
              cursor: orderFiles.length > 0 && !processing ? "pointer" : "default",
              boxShadow: orderFiles.length > 0 && !processing ? "0 2px 10px rgba(0,88,180,0.25)" : "none",
              display: "flex", alignItems: "center", gap: "7px"
            }}>
            {processing ? (
              <><span style={{
                display: "inline-block", width: "13px", height: "13px",
                border: "2px solid rgba(255,255,255,0.25)", borderTopColor: "#fff",
                borderRadius: "50%", animation: "spin 0.7s linear infinite"
              }} />Extracting...</>
            ) : "Extract Products"}
          </button>

          {processing && progressMsg && (
            <span style={{ fontSize: "12px", color: "#5a8aaa" }}>{progressMsg}</span>
          )}

          {hasData && !processing && (
            <>
              <button onClick={() => { setExtractedData([]); setDiscountChoices({}); setCsvReady(null); setGeneratedEmail(null); processFiles(); }}
                style={{ ...btnStyle, color: "#ee8833", borderColor: "rgba(255,140,30,0.2)" }}
                title="Re-run extraction on all uploaded files">â†» Re-extract</button>
              {aiInstructions && (
                <button onClick={async () => {
                  setProcessing(true);
                  setProgressMsg("Applying instructions...");
                  addLog("Applying AI instructions to extracted data...");
                  
                  const currentData = extractedData.map((row, idx) => ({
                    row: idx, itemNo: row.itemNo, productId: row.productId,
                    description: row.description, qty: row.qty,
                    currentDiscount: discountChoices[idx] !== undefined ? discountChoices[idx] : row.discount,
                    customer: row.matchedCustomer?.name || row.customerName || "",
                  }));
                  
                  const applyPrompt = `You are updating product order data based on user instructions.

CURRENT DATA:
${JSON.stringify(currentData, null, 1)}

USER INSTRUCTIONS:
${aiInstructions}

TASK: Apply the user's instructions to update the data. Return a JSON object with two fields:
1. "rows": array with one object per row for row-level changes
2. "distributor": string name of distributor/BSS branch if mentioned, or null

IMPORTANT DISTINCTION:
- "customer" / "installer" = the end customer who ordered the product (per-row, different customers per row possible)
- "distributor" = the BSS branch that sent the order (applies to ALL rows, shown in header only)
- If user says "distributor is X" or "branch is X", set distributor ONLY â€” do NOT change any customers
- If user says "customer is X" or "installer is X", set customer on rows â€” do NOT change distributor
- Only set "customer" in rows array if user explicitly asks to change the installer/customer
- Use null for any field that should NOT change

Each row object: "row" (0-based index), "discount" (number or null), "productId" (string or null), "customer" (string or null)

Category matching guide:
- CAT 1 = standard pumps: MAGNA (without N suffix), UPS, UP, TP, TPE, CM, CR, CRE, SE, NK, NB etc.
- HW Circulators / domestic hot water = MAGNA with N in name (e.g. MAGNA1, MAGNA3 with "N" like "25-40 N 180")
- CAT 3B BOOSTERS = cold water boosters: Hydro MPC, Hydro Multi, booster sets, MPC-E
- CAT 3B PU = pressurisation units: pressurisation, Transfero, CME
- Homeboosters = home booster: MD, ME, HOME BOOSTER
- If user says change product code, update productId for matching rows

Return ONLY valid JSON, no markdown:
{"distributor":"BSS Lewes","rows":[{"row":0,"discount":60.98,"productId":null,"customer":null}]}`;

                  try {
                    const resp = await fetch("https://api.anthropic.com/v1/messages", {
                      method: "POST",
                      headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
                      body: JSON.stringify({
                        model: "claude-sonnet-4-20250514", max_tokens: 2000,
                        messages: [{ role: "user", content: applyPrompt }]
                      })
                    });
                    if (resp.ok) {
                      const data = await resp.json(); trackUsage(data);
                      const text = data.content?.map(b => b.type === "text" ? b.text : "").join("") || "";
                      const parsed = JSON.parse(text.replace(/```json|```/g, "").trim());
                      // Handle both formats: {distributor, rows:[...]} or [...] (legacy)
                      const updates = Array.isArray(parsed) ? parsed : (parsed.rows || []);
                      const distName = parsed.distributor || null;
                      
                      if (Array.isArray(updates)) {
                        const newChoices = { ...discountChoices };
                        let discUp = 0, codeUp = 0, custUp = 0;
                        
                        setExtractedData(prev => {
                          const updated = [...prev];
                          
                          // Apply distributor to all rows if specified
                          if (distName) {
                            const distMatch = findCustomer(distName);
                            if (distMatch) {
                              for (let i = 0; i < updated.length; i++) {
                                updated[i] = { ...updated[i], distributorName: distName, matchedDistributor: distMatch };
                              }
                              addLog(`âœ“ Set distributor: ${distMatch.name} (ID: ${distMatch.id})`);
                            } else {
                              for (let i = 0; i < updated.length; i++) {
                                updated[i] = { ...updated[i], distributorName: distName, matchedDistributor: null };
                              }
                              addLog(`âš  Distributor "${distName}" not found in terms`);
                            }
                          }
                          
                          // Apply per-row updates
                          updates.forEach(u => {
                            const idx = u.row;
                            if (idx >= 0 && idx < updated.length) {
                              if (u.discount != null) { newChoices[idx] = Number(u.discount); discUp++; }
                              if (u.productId != null) { updated[idx] = { ...updated[idx], productId: u.productId }; codeUp++; }
                              if (u.customer != null) {
                                const found = findCustomer(u.customer);
                                if (found) { updated[idx] = { ...updated[idx], matchedCustomer: found, customerName: found.name }; custUp++; }
                              }
                            }
                          });
                          return updated;
                        });
                        setDiscountChoices(newChoices);
                        
                        const parts = [];
                        if (discUp) parts.push(`${discUp} discounts`);
                        if (codeUp) parts.push(`${codeUp} product codes`);
                        if (custUp) parts.push(`${custUp} customers`);
                        addLog(`âœ“ Applied: ${parts.join(", ")} updated`);
                      }
                    } else {
                      addLog(`âœ— Apply API error: ${resp.status}`);
                    }
                  } catch (err) {
                    addLog(`âœ— Apply error: ${err.message}`);
                  }
                  setProcessing(false);
                  setProgressMsg("");
                }}
                  disabled={processing}
                  style={{ ...btnStyle, color: "#40aa70", borderColor: "rgba(0,180,100,0.2)" }}
                  title="Apply AI instructions to current data">â–¶ Apply</button>
              )}
              <button onClick={addRow} style={btnStyle}>+ Row</button>
              <button onClick={copyTable} style={btnStyle}>Copy</button>
              <button onClick={() => setShowLogs(p => !p)} style={{ ...btnStyle, color: "#4a7090" }}>
                {showLogs ? "Hide" : "Show"} Logs
              </button>
              {apiCost.calls > 0 && (
                <span title={`${apiCost.calls} API call${apiCost.calls !== 1 ? "s" : ""} â€¢ ${apiCost.inputTokens.toLocaleString()} input + ${apiCost.outputTokens.toLocaleString()} output tokens`}
                  style={{ fontSize: "10px", color: "#4a7a9e", padding: "4px 8px", borderRadius: "6px", background: "rgba(0,60,120,0.08)", border: "1px solid rgba(0,140,255,0.06)", cursor: "default", whiteSpace: "nowrap" }}>
                  ðŸ’° ~${((apiCost.inputTokens / 1000000 * 3) + (apiCost.outputTokens / 1000000 * 15)).toFixed(4)} ({apiCost.calls} call{apiCost.calls !== 1 ? "s" : ""})
                </span>
              )}
              <div style={{ flex: 1 }} />
              <button onClick={generateExport} style={{
                padding: "9px 22px", borderRadius: "8px", border: "none",
                background: "linear-gradient(135deg, #00764e, #00a86a)",
                color: "#fff", fontSize: "13px", fontWeight: "600", cursor: "pointer",
                boxShadow: "0 2px 10px rgba(0,120,75,0.25)"
              }}>Copy to Template</button>
              <button onClick={() => {
                const uniqueSources = [...new Set(extractedData.map(r => r.source))];
                const isMultiple = uniqueSources.length > 1;
                
                // Build plain text version for preview
                const header = "Part Number\tQuantity\tItem Discount\tCustomer Item Reference";
                const tRows = extractedData.map((row, idx) => {
                  const disc = discountChoices[idx] !== undefined ? discountChoices[idx] : row.discount;
                  return `${row.productId}\t${row.qty}\t${disc !== "" && disc != null ? disc : ""}\t${row.customerRef}`;
                });
                const plainTable = "\n\n" + header + "\n" + tRows.join("\n") + "";
                const plainEmail = `Hi${replyName ? " " + replyName : ""},\n\nHope all is well.\n\n${isMultiple ? "These have now been sorted." : "This has now been sorted."}\n\nPlease see attached confirmation.${plainTable}`;
                setGeneratedEmail(plainEmail);
                
                // Build HTML version for rich paste into Outlook
                const htmlRows = extractedData.map((row, idx) => {
                  const disc = discountChoices[idx] !== undefined ? discountChoices[idx] : row.discount;
                  return `<tr><td style="padding:4px 12px 4px 0;color:#000;background:#fff">${row.productId}</td><td style="padding:4px 12px 4px 0;text-align:center;color:#000;background:#fff">${row.qty}</td><td style="padding:4px 12px 4px 0;text-align:center;color:#000;background:#fff">${disc !== "" && disc != null ? disc : ""}</td><td style="padding:4px 12px 4px 0;color:#000;background:#fff">${row.customerRef}</td></tr>`;
                }).join("");
                const htmlEmail = `<div style="font-family:Calibri,Arial,sans-serif;font-size:11pt;color:#000;background:#fff">Hi${replyName ? " " + replyName : ""},<br><br>Hope all is well.<br><br>${isMultiple ? "These have now been sorted." : "This has now been sorted."}<br><br>Please see attached confirmation.<br><br><table style="border-collapse:collapse;font-family:Calibri,Arial,sans-serif;font-size:11pt;background:#fff;color:#000"><tr><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Part Number</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Quantity</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Item Discount</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Customer Item Reference</td></tr>${htmlRows}</table></div>`;
                
                // Copy as rich HTML to clipboard
                try {
                  const div = document.createElement("div");
                  div.innerHTML = htmlEmail;
                  div.style.cssText = "position:fixed;left:-9999px;top:-9999px";
                  document.body.appendChild(div);
                  const range = document.createRange();
                  range.selectNodeContents(div);
                  const sel = window.getSelection();
                  sel.removeAllRanges();
                  sel.addRange(range);
                  document.execCommand("copy");
                  sel.removeAllRanges();
                  document.body.removeChild(div);
                } catch(e) {
                  // Fallback to plain text copy
                  try { const ta = document.createElement("textarea"); ta.value = plainEmail; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); } catch(e2) {}
                }
              }} style={{
                padding: "9px 16px", borderRadius: "8px", border: "none",
                background: "linear-gradient(135deg, #5a3e9e, #7a5ec0)",
                color: "#fff", fontSize: "13px", fontWeight: "600", cursor: "pointer",
                boxShadow: "0 2px 10px rgba(90,60,160,0.25)"
              }}>ðŸ“§ Reply Email</button>
            </>
          )}
        </div>

        {/* Logs */}
        {showLogs && logs.length > 0 && (
          <div style={{
            padding: "10px 14px", borderRadius: "10px", marginBottom: "12px",
            background: "rgba(0,8,20,0.5)", border: "1px solid rgba(0,140,255,0.07)",
            maxHeight: "150px", overflowY: "auto", fontSize: "11px",
            fontFamily: "'Cascadia Code', 'Consolas', 'SF Mono', monospace",
            lineHeight: "1.9", color: "#4a7a9e"
          }}>
            {logs.map((log, i) => (
              <div key={i} style={{
                color: log.includes("âœ“") || log.includes("COMPLETE") ? "#3ecc7a"
                  : log.includes("âœ—") ? "#cc5555"
                  : log.includes("âš ") ? "#ccaa44" : "#4a7a9e"
              }}>{log}</div>
            ))}
            <div ref={logsEndRef} />
          </div>
        )}

        {/* Results Table */}
        {hasData && (
          <div style={{
            borderRadius: "11px", overflow: "hidden",
            border: "1px solid rgba(0,140,255,0.08)",
            background: "rgba(0,15,30,0.4)"
          }}>
            <div style={{
              padding: "10px 14px", background: "rgba(0,80,150,0.06)",
              borderBottom: "1px solid rgba(0,140,255,0.07)",
              display: "flex", justifyContent: "space-between", alignItems: "center"
            }}>
              <span style={{ fontSize: "12px", fontWeight: "600", color: "#7aaccc" }}>
                {extractedData.length} Grundfos item{extractedData.length !== 1 ? "s" : ""} â€” all documents combined
              </span>
              <span style={{ fontSize: "10px", color: "#3a6080" }}>Click cells to edit â€¢ Choose discount when flagged</span>
            </div>

            {/* Installer & Distributor Info Panel */}
            {(() => {
              // Get unique matched customers
              const customers = [...new Map(extractedData.filter(r => r.matchedCustomer).map(r => [r.matchedCustomer.id, r.matchedCustomer])).values()];
              // Get unique unmatched customer names (from AI extraction)
              const unmatchedCusts = [...new Set(extractedData.filter(r => !r.matchedCustomer && r.customerName).map(r => r.customerName))];
              // Get unique matched distributors
              const distributors = [...new Map(extractedData.filter(r => r.matchedDistributor).map(r => [r.matchedDistributor.id, r.matchedDistributor])).values()];
              // Get unique unmatched distributor names
              const unmatchedDists = [...new Set(extractedData.filter(r => r.distributorName && !r.matchedDistributor).map(r => r.distributorName))];
              
              if (customers.length === 0 && unmatchedCusts.length === 0 && distributors.length === 0 && unmatchedDists.length === 0) return null;
              
              return (
                <div style={{
                  padding: "8px 14px", background: "rgba(0,60,120,0.06)",
                  borderBottom: "1px solid rgba(0,140,255,0.07)",
                  display: "flex", gap: "24px", flexWrap: "wrap", fontSize: "11px"
                }}>
                  {customers.map((c, i) => (
                    <div key={"c" + i} style={{ display: "flex", flexDirection: "column", gap: "1px" }}>
                      <span style={{ fontSize: "8px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px" }}>Installer</span>
                      <span style={{ color: "#8ac0e8", fontWeight: "600" }}>{c.name}</span>
                      <span style={{ color: "#5a8aaa", fontSize: "10px" }}>ID: {c.id}</span>
                    </div>
                  ))}
                  {unmatchedCusts.map((name, i) => (
                    <div key={"uc" + i} style={{ display: "flex", flexDirection: "column", gap: "1px" }}>
                      <span style={{ fontSize: "8px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px" }}>Installer</span>
                      <span style={{ color: "#bbaa44", fontWeight: "600" }}>{name}</span>
                      <span style={{ color: "#887744", fontSize: "10px" }}>Not in terms â€” <span style={{ cursor: "pointer", textDecoration: "underline" }} onClick={() => { setPickerTarget("all"); setShowPicker(true); }}>assign</span></span>
                    </div>
                  ))}
                  {distributors.map((d, i) => (
                    <div key={"d" + i} style={{ display: "flex", flexDirection: "column", gap: "1px" }}>
                      <span style={{ fontSize: "8px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px" }}>Distributor</span>
                      <span style={{ color: "#8ac0e8", fontWeight: "600" }}>{d.name}</span>
                      <span style={{ color: "#5a8aaa", fontSize: "10px" }}>ID: {d.id}</span>
                    </div>
                  ))}
                  {unmatchedDists.map((name, i) => (
                    <div key={"ud" + i} style={{ display: "flex", flexDirection: "column", gap: "1px" }}>
                      <span style={{ fontSize: "8px", fontWeight: "600", color: "#4a7a9e", textTransform: "uppercase", letterSpacing: "0.5px" }}>Distributor</span>
                      <span style={{ color: "#bbaa44", fontWeight: "600" }}>{name}</span>
                      <span style={{ color: "#887744", fontSize: "10px" }}>Not in terms</span>
                    </div>
                  ))}
                </div>
              );
            })()}

            <div style={{ overflowX: "auto" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "12px", fontFamily: "'Cascadia Code', 'Consolas', 'SF Mono', monospace" }}>
                <thead>
                  <tr style={{ borderBottom: "1px solid rgba(0,140,255,0.07)" }}>
                    {["#", "Ref", "Product ID", "Description", "Qty", "Discount", "Customer", "Validation", ""].map((h, i) => (
                      <th key={i} style={{
                        padding: "8px 7px", textAlign: "left", color: "#3a6888",
                        fontWeight: "600", fontSize: "9px", textTransform: "uppercase",
                        letterSpacing: "0.5px", whiteSpace: "nowrap"
                      }}>{h === "Customer" ? (
                        <span style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                          Customer
                          <span onClick={() => { setPickerTarget("all"); setShowPicker(true); }}
                            style={{ color: "#5a90bb", cursor: "pointer", fontSize: "8px", fontWeight: "400", textTransform: "none" }}
                            onMouseEnter={(e) => e.target.style.color = "#8ac0e8"}
                            onMouseLeave={(e) => e.target.style.color = "#5a90bb"}>
                            [Assign All]
                          </span>
                        </span>
                      ) : h === "Discount" ? (
                        <span style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                          Discount
                          {!showSetAllDiscount ? (
                            <span onClick={() => setShowSetAllDiscount(true)}
                              style={{ color: "#5a90bb", cursor: "pointer", fontSize: "8px", fontWeight: "400", textTransform: "none" }}
                              onMouseEnter={(e) => e.target.style.color = "#8ac0e8"}
                              onMouseLeave={(e) => e.target.style.color = "#5a90bb"}>
                              [Set All]
                            </span>
                          ) : (
                            <span style={{ display: "flex", alignItems: "center", gap: "3px" }}>
                              <input
                                autoFocus
                                type="number"
                                placeholder="%"
                                style={{ width: "42px", padding: "1px 4px", fontSize: "10px", borderRadius: "3px", border: "1px solid rgba(0,140,255,0.2)", background: "rgba(0,15,35,0.6)", color: "#8ac0e8", outline: "none", textTransform: "none" }}
                                onKeyDown={(e) => {
                                  if (e.key === "Enter") {
                                    const num = Number(e.target.value);
                                    if (!isNaN(num) && e.target.value !== "") {
                                      const newChoices = {};
                                      extractedData.forEach((_, i) => { newChoices[i] = num; });
                                      setDiscountChoices(newChoices);
                                      addLog(`âœ“ Set ${num}% discount on all ${extractedData.length} rows`);
                                    }
                                    setShowSetAllDiscount(false);
                                  }
                                  if (e.key === "Escape") setShowSetAllDiscount(false);
                                }}
                                onBlur={() => setShowSetAllDiscount(false)}
                              />
                            </span>
                          )}
                        </span>
                      ) : h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {extractedData.map((row, idx) => {
                    const finalDisc = getFinalDiscount(row, idx);
                    const validation = validateDiscount(finalDisc, row.matchedCustomer);
                    const groups = row.matchedCustomer ? getDiscountGroups(row.matchedCustomer) : {};
                    const isMismatch = (validation.status === "mismatch" || validation.status === "missing_with_terms") && discountChoices[idx] === undefined;

                    return (
                      <tr key={idx} style={{ borderBottom: "1px solid rgba(0,140,255,0.04)" }}
                        onMouseEnter={(e) => e.currentTarget.style.background = "rgba(0,80,150,0.04)"}
                        onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}>
                        <td style={{ padding: "4px 7px", color: "#3a6080", fontSize: "11px", width: "36px" }}>{row.itemNo}</td>
                        <td style={{ padding: "4px 7px", width: "90px" }}>
                          <EditableCell value={row.customerRef} rowIdx={idx} field="customerRef" />
                        </td>
                        <td style={{ padding: "4px 7px", width: "90px" }}>
                          <EditableCell value={row.productId} rowIdx={idx} field="productId" style={{ color: "#40aaee", fontWeight: "600" }} />
                        </td>
                        <td style={{ padding: "4px 7px", width: "160px", fontSize: "11px" }}>
                          <EditableCell value={row.description} rowIdx={idx} field="description" />
                        </td>
                        <td style={{ padding: "4px 7px", width: "44px" }}>
                          <EditableCell value={row.qty} rowIdx={idx} field="qty" type="number" />
                        </td>
                        {/* Discount cell with mismatch choice */}
                        <td style={{ padding: "4px 7px", width: "110px" }}>
                          {isMismatch ? (
                            <div style={{ display: "flex", flexDirection: "column", gap: "3px" }}>
                              <div style={{ fontSize: "10px", color: "#ee8833", fontWeight: "600" }}>
                                {validation.status === "missing_with_terms" ? "No discount â€” choose:" : `Order: ${row.discount}% â€” Use which?`}
                              </div>
                              <div style={{ display: "flex", gap: "3px", flexWrap: "wrap" }}>
                                {row.discount !== "" && row.discount != null && (
                                  <button onClick={() => applyTermsDiscount(idx, row.discount)} style={choiceBtnStyle("#ee8833")}>
                                    Order ({row.discount}%)
                                  </button>
                                )}
                                {Object.entries(groups).map(([gk, gv]) => (
                                  <button key={gk} onClick={() => applyTermsDiscount(idx, gv)} style={choiceBtnStyle("#40aa70")}>
                                    {gk} ({gv}%)
                                  </button>
                                ))}
                              </div>
                              <input
                                type="number"
                                placeholder="or type %"
                                onKeyDown={(e) => { if (e.key === "Enter" && e.target.value) { applyTermsDiscount(idx, Number(e.target.value)); } }}
                                onBlur={(e) => { if (e.target.value) applyTermsDiscount(idx, Number(e.target.value)); }}
                                style={{
                                  width: "70px", padding: "2px 5px", borderRadius: "4px", marginTop: "2px",
                                  border: "1px solid rgba(0,140,255,0.15)", background: "rgba(0,15,30,0.5)",
                                  color: "#8ac0e8", fontSize: "10px", outline: "none"
                                }}
                              />
                            </div>
                          ) : (
                            <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                              <EditableCell value={finalDisc} rowIdx={idx} field="discount" type="number" />
                              {discountChoices[idx] !== undefined && (
                                <span onClick={() => setDiscountChoices(prev => { const n = {...prev}; delete n[idx]; return n; })}
                                  style={{ fontSize: "8px", color: "#4a7090", cursor: "pointer", textDecoration: "underline" }}>â†º</span>
                              )}
                            </div>
                          )}
                          )}
                        </td>
                        {/* Customer column */}
                        <td style={{ padding: "4px 7px", width: "120px" }}>
                          {row.matchedCustomer ? (
                            <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                              <span style={{ fontSize: "11px", color: "#6aaa8a", maxWidth: "90px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                                {row.matchedCustomer.name}
                              </span>
                              <span onClick={() => { setPickerTarget(idx); setShowPicker(true); setCustomerSearch(""); }}
                                style={{ fontSize: "9px", color: "#4a7090", cursor: "pointer", textDecoration: "underline" }}>âœŽ</span>
                            </div>
                          ) : row.customerName ? (
                            <div>
                              <div style={{ fontSize: "10px", color: "#bbaa44" }}>{row.customerName}</div>
                              <span onClick={() => { setPickerTarget(idx); setShowPicker(true); setCustomerSearch(row.customerName); }}
                                style={{ fontSize: "9px", color: "#4a7090", cursor: "pointer", textDecoration: "underline" }}>Find in terms</span>
                            </div>
                          ) : (
                            <span onClick={() => { setPickerTarget(idx); setShowPicker(true); setCustomerSearch(""); }}
                              style={{ fontSize: "10px", color: "#3a6080", cursor: "pointer", textDecoration: "underline" }}>Assign</span>
                          )}
                        </td>
                        {/* Validation badge */}
                        <td style={{ padding: "4px 7px", width: "155px" }}>
                          <div style={{
                            padding: "2px 7px", borderRadius: "5px", fontSize: "10px", fontWeight: "500",
                            display: "inline-flex", alignItems: "center", gap: "3px", whiteSpace: "nowrap",
                            background: valColors[validation.status]?.bg || "transparent",
                            border: `1px solid ${valColors[validation.status]?.border || "transparent"}`,
                            color: valColors[validation.status]?.text || "#777",
                          }} title={validation.msg}>
                            <span style={{ maxWidth: "130px", overflow: "hidden", textOverflow: "ellipsis" }}>{validation.msg}</span>
                          </div>
                        </td>
                        <td style={{ padding: "4px 4px", width: "48px", whiteSpace: "nowrap" }}>
                          <button onClick={() => insertRowAt(idx)}
                            title="Insert row above"
                            style={{ background: "none", border: "none", color: "#305050", cursor: "pointer", fontSize: "11px", padding: "2px 3px", borderRadius: "4px" }}
                            onMouseEnter={(e) => { e.target.style.color = "#40aa70"; e.target.style.background = "rgba(0,180,100,0.08)"; }}
                            onMouseLeave={(e) => { e.target.style.color = "#305050"; e.target.style.background = "none"; }}>+â†‘</button>
                          <button onClick={() => deleteRow(idx)}
                            style={{ background: "none", border: "none", color: "#4a3030", cursor: "pointer", fontSize: "13px", padding: "2px 4px", borderRadius: "4px" }}
                            onMouseEnter={(e) => { e.target.style.color = "#ff5555"; e.target.style.background = "rgba(255,50,50,0.08)"; }}
                            onMouseLeave={(e) => { e.target.style.color = "#4a3030"; e.target.style.background = "none"; }}>Ã—</button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div style={{ padding: "6px 14px", borderTop: "1px solid rgba(0,140,255,0.05)" }}>
                <button onClick={addRow}
                  style={{ background: "none", border: "1px dashed rgba(0,180,100,0.15)", color: "#305050", cursor: "pointer", fontSize: "11px", padding: "4px 10px", borderRadius: "5px", width: "100%" }}
                  onMouseEnter={(e) => { e.target.style.color = "#40aa70"; e.target.style.borderColor = "rgba(0,180,100,0.3)"; }}
                  onMouseLeave={(e) => { e.target.style.color = "#305050"; e.target.style.borderColor = "rgba(0,180,100,0.15)"; }}>+ Add row below</button>
              </div>
            </div>
          </div>
        )}

        {/* Customer Picker Modal */}
        {showPicker && (
          <div style={{
            position: "fixed", inset: 0, background: "rgba(0,0,0,0.6)",
            display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000
          }} onClick={() => { setShowPicker(false); setPickerTarget(null); }}>
            <div style={{
              width: "420px", maxHeight: "500px", borderRadius: "14px",
              background: "linear-gradient(180deg, #0a1a2e, #061222)",
              border: "1px solid rgba(0,140,255,0.12)", padding: "18px",
              boxShadow: "0 20px 60px rgba(0,0,0,0.5)"
            }} onClick={(e) => e.stopPropagation()}>
              <div style={{ fontSize: "14px", fontWeight: "600", color: "#8ac0e8", marginBottom: "12px" }}>
                {pickerTarget === "all" ? "Assign Customer â€” All Rows" : pickerTarget !== null ? `Assign Customer â€” Row ${extractedData[pickerTarget]?.itemNo}` : "Select Customer"}
              </div>
              <input
                ref={searchInputRef}
                autoFocus
                value={customerSearch}
                onChange={(e) => setCustomerSearch(e.target.value)}
                placeholder="Search customer name or ID..."
                style={{
                  width: "100%", padding: "9px 14px", borderRadius: "8px",
                  border: "1px solid rgba(0,140,255,0.15)", background: "rgba(0,15,35,0.6)",
                  color: "#8ac0e8", fontSize: "13px", outline: "none", marginBottom: "8px"
                }}
              />
              <div style={{ maxHeight: "340px", overflowY: "auto" }}>
                {filteredCustomers.length === 0 && customerSearch.length >= 2 && (
                  <div style={{ padding: "16px", textAlign: "center", color: "#3a6080", fontSize: "12px" }}>
                    No customers found
                  </div>
                )}
                {filteredCustomers.map((c, i) => {
                  const groups = getDiscountGroups(c);
                  return (
                    <div key={i}
                      onClick={() => {
                        if (pickerTarget === "all") {
                          // Assign to all rows
                          setExtractedData(prev => prev.map(row => ({ ...row, matchedCustomer: c, customerName: c.name })));
                          addLog(`âœ“ Assigned ${c.name} to all rows`);
                        } else if (pickerTarget !== null) {
                          assignCustomerToRow(pickerTarget, c);
                          addLog(`âœ“ Row ${extractedData[pickerTarget]?.itemNo}: assigned ${c.name}`);
                        }
                        setShowPicker(false);
                        setPickerTarget(null);
                        setCustomerSearch("");
                      }}
                      style={{
                        padding: "9px 12px", cursor: "pointer", borderRadius: "7px",
                        marginBottom: "3px", transition: "background 0.1s"
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = "rgba(0,80,150,0.12)"}
                      onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}>
                      <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                        <span style={{ fontSize: "13px", fontWeight: "600", color: "#7aaccc" }}>{c.name}</span>
                        <span style={{ fontSize: "10px", color: "#3a6080" }}>{c.id}</span>
                        {c.group && <span style={{ fontSize: "9px", color: "#2e5070", padding: "1px 6px", borderRadius: "3px", background: "rgba(0,60,120,0.15)" }}>{c.group}</span>}
                      </div>
                      {Object.keys(groups).length > 0 && (
                        <div style={{ display: "flex", gap: "6px", marginTop: "4px", flexWrap: "wrap" }}>
                          {Object.entries(groups).map(([k, v]) => (
                            <span key={k} style={{ fontSize: "10px", color: "#5a8aaa" }}>{k}: <strong style={{ color: "#70bbee" }}>{v}%</strong></span>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              <div style={{ marginTop: "10px", textAlign: "right" }}>
                <button onClick={() => { setShowPicker(false); setPickerTarget(null); }}
                  style={{ padding: "6px 16px", borderRadius: "6px", border: "1px solid rgba(0,140,255,0.1)", background: "rgba(0,30,55,0.4)", color: "#6a9abb", fontSize: "12px", cursor: "pointer" }}>
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {/* CSV Output */}
        {csvReady && (
          <div style={{
            marginTop: "14px", borderRadius: "10px", overflow: "hidden",
            border: "1px solid rgba(0,180,100,0.15)", background: "rgba(0,40,20,0.2)"
          }}>
            <div style={{
              padding: "8px 14px", background: "rgba(0,120,60,0.1)",
              borderBottom: "1px solid rgba(0,180,100,0.1)",
              display: "flex", alignItems: "center", gap: "10px"
            }}>
              <span style={{ fontSize: "12px", fontWeight: "600", color: "#40aa70" }}>âœ“ Ready to paste into Product Bulk Entry template</span>
              <button onClick={() => {
                const ta = document.createElement("textarea");
                ta.value = csvReady;
                ta.style.cssText = "position:fixed;left:-9999px;top:-9999px";
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand("copy"); addLog("âœ“ CSV copied to clipboard"); } catch(e) { addLog("âš  Copy failed â€” select all from text box"); }
                document.body.removeChild(ta);
              }} style={{
                padding: "4px 12px", borderRadius: "5px", border: "1px solid rgba(0,180,100,0.2)",
                background: "rgba(0,80,40,0.2)", color: "#40cc80", fontSize: "11px",
                fontWeight: "600", cursor: "pointer"
              }}>Copy CSV</button>
              <span style={{ fontSize: "10px", color: "#3a7a5a" }}>Open Product_Bulk_Entry.xlsx â†’ click cell A6 â†’ Ctrl+V</span>
              <div style={{ flex: 1 }} />
              <span onClick={() => setCsvReady(null)}
                style={{ color: "#3a6050", cursor: "pointer", fontSize: "13px" }}>Ã—</span>
            </div>
            <textarea
              readOnly
              value={csvReady}
              style={{
                width: "100%", height: "160px", padding: "8px 12px", border: "none",
                background: "rgba(0,10,5,0.4)", color: "#5a9a7a", fontSize: "11px",
                fontFamily: "'Cascadia Code', 'Consolas', monospace", resize: "vertical", outline: "none"
              }}
              onFocus={(e) => e.target.select()}
            />
          </div>
        )}

        {/* Email Response */}
        {generatedEmail && (
          <div style={{
            marginTop: "14px", borderRadius: "10px", overflow: "hidden",
            border: "1px solid rgba(120,80,200,0.15)", background: "rgba(30,15,50,0.2)"
          }}>
            <div style={{
              padding: "8px 14px", background: "rgba(90,60,160,0.1)",
              borderBottom: "1px solid rgba(120,80,200,0.1)",
              display: "flex", alignItems: "center", gap: "10px"
            }}>
              <span style={{ fontSize: "12px", fontWeight: "600", color: "#9a80cc" }}>ðŸ“§ Reply email copied to clipboard</span>
              <div style={{ display: "flex", alignItems: "center", gap: "6px", padding: "3px 8px", borderRadius: "5px", background: "rgba(60,30,100,0.15)", border: "1px solid rgba(120,80,200,0.15)" }}>
                <span style={{ fontSize: "11px", color: "#b09ae0", fontWeight: "500" }}>Subject:</span>
                <span style={{ fontSize: "11px", color: "#d0c0f0" }}>Outstanding Supports</span>
                <button onClick={() => {
                  try { const ta = document.createElement("textarea"); ta.value = "Outstanding Supports"; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); } catch(e) {}
                }} style={{
                  padding: "1px 8px", borderRadius: "4px", border: "1px solid rgba(120,80,200,0.2)",
                  background: "rgba(60,30,100,0.2)", color: "#b09ae0", fontSize: "10px",
                  cursor: "pointer"
                }}>Copy</button>
              </div>
              <input
                type="text"
                placeholder="Contact name (e.g. Rebecca)"
                value={replyName}
                onChange={(e) => {
                  setReplyName(e.target.value);
                  const uniqueSources = [...new Set(extractedData.map(r => r.source))];
                  const isMultiple = uniqueSources.length > 1;
                  const name = e.target.value;
                  const header = "Part Number\tQuantity\tItem Discount\tCustomer Item Reference";
                  const tRows = extractedData.map((row, idx) => {
                    const disc = discountChoices[idx] !== undefined ? discountChoices[idx] : row.discount;
                    return `${row.productId}\t${row.qty}\t${disc !== "" && disc != null ? disc : ""}\t${row.customerRef}`;
                  });
                  const table = "\n\n" + header + "\n" + tRows.join("\n") + "";
                  setGeneratedEmail(`Hi${name ? " " + name : ""},\n\nHope all is well.\n\n${isMultiple ? "These have now been sorted." : "This has now been sorted."}\n\nPlease see attached confirmation.${table}`);                }}
                style={{
                  padding: "3px 8px", borderRadius: "5px", width: "160px",
                  border: "1px solid rgba(120,80,200,0.2)", background: "rgba(30,15,50,0.4)",
                  color: "#b09ae0", fontSize: "11px", outline: "none"
                }}
              />
              <button onClick={() => {
                // Rebuild HTML from current state
                const uniqueSources = [...new Set(extractedData.map(r => r.source))];
                const isMultiple = uniqueSources.length > 1;
                const htmlRows = extractedData.map((row, idx) => {
                  const disc = discountChoices[idx] !== undefined ? discountChoices[idx] : row.discount;
                  return `<tr><td style="padding:4px 12px 4px 0;color:#000;background:#fff">${row.productId}</td><td style="padding:4px 12px 4px 0;text-align:center;color:#000;background:#fff">${row.qty}</td><td style="padding:4px 12px 4px 0;text-align:center;color:#000;background:#fff">${disc !== "" && disc != null ? disc : ""}</td><td style="padding:4px 12px 4px 0;color:#000;background:#fff">${row.customerRef}</td></tr>`;
                }).join("");
                const htmlEmail = `<div style="font-family:Calibri,Arial,sans-serif;font-size:11pt;color:#000;background:#fff">Hi${replyName ? " " + replyName : ""},<br><br>Hope all is well.<br><br>${isMultiple ? "These have now been sorted." : "This has now been sorted."}<br><br>Please see attached confirmation.<br><br><table style="border-collapse:collapse;font-family:Calibri,Arial,sans-serif;font-size:11pt;background:#fff;color:#000"><tr><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Part Number</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Quantity</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Item Discount</td><td style="padding:4px 12px 4px 0;font-weight:bold;color:#000;background:#fff">Customer Item Reference</td></tr>${htmlRows}</table></div>`;
                try {
                  const div = document.createElement("div");
                  div.innerHTML = htmlEmail;
                  div.style.cssText = "position:fixed;left:-9999px;top:-9999px";
                  document.body.appendChild(div);
                  const range = document.createRange();
                  range.selectNodeContents(div);
                  const sel = window.getSelection();
                  sel.removeAllRanges();
                  sel.addRange(range);
                  document.execCommand("copy");
                  sel.removeAllRanges();
                  document.body.removeChild(div);
                } catch(e) {
                  try { const ta = document.createElement("textarea"); ta.value = generatedEmail; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); } catch(e2) {}
                }
              }} style={{
                padding: "4px 12px", borderRadius: "5px", border: "1px solid rgba(120,80,200,0.2)",
                background: "rgba(60,30,100,0.2)", color: "#b09ae0", fontSize: "11px",
                fontWeight: "600", cursor: "pointer"
              }}>Copy</button>
              <div style={{ flex: 1 }} />
              <span onClick={() => setGeneratedEmail(null)}
                style={{ color: "#5a4080", cursor: "pointer", fontSize: "13px" }}>Ã—</span>
            </div>
            <textarea
              readOnly
              value={generatedEmail}
              style={{
                width: "100%", height: "220px", padding: "8px 12px", border: "none",
                background: "rgba(15,5,30,0.4)", color: "#b09ae0", fontSize: "12px",
                fontFamily: "'Segoe UI', sans-serif", resize: "vertical", outline: "none",
                lineHeight: "1.6"
              }}
              onFocus={(e) => e.target.select()}
            />
          </div>
        )}

        {/* Empty state */}
        {!hasData && !processing && (
          <div style={{ textAlign: "center", padding: "36px 20px", color: "#2e4e68" }}>
            <div style={{ fontSize: "13px", marginBottom: "6px" }}>No data extracted yet</div>
            <div style={{ fontSize: "11px", color: "#1e3e58" }}>
              Upload BSS order documents above, then click Extract
            </div>
          </div>
        )}

        {/* Footer */}
        <div style={{
          marginTop: "16px", padding: "12px 16px", borderRadius: "9px",
          background: "rgba(0,15,30,0.3)", border: "1px solid rgba(0,140,255,0.05)",
          fontSize: "11px", color: "#2e5070", lineHeight: "1.7"
        }}>
          <strong style={{ color: "#4a7a9e" }}>Workflow:</strong> Upload order PDFs + email screenshot (optional) â†’ AI extracts products &amp; maps customers â†’ Discounts validated against terms â†’ Choose correct discount when flagged â†’ Copy to Template â†’ paste into Product_Bulk_Entry.xlsx at cell A6.
        </div>

        </>)}

        {/* â•â•â•â•â•â•â• CUSTOMER TERMS TAB â•â•â•â•â•â•â• */}
        {activeTab === "terms" && (
          <div>
            {/* Search & Filter Bar */}
            <div style={{
              display: "flex", gap: "10px", marginBottom: "14px", flexWrap: "wrap", alignItems: "center"
            }}>
              <div style={{ flex: 1, minWidth: "220px" }}>
                <input
                  value={termsSearch}
                  onChange={(e) => setTermsSearch(e.target.value)}
                  placeholder="Search by customer name or ID..."
                  style={{
                    width: "100%", padding: "9px 14px", borderRadius: "8px",
                    border: "1px solid rgba(0,140,255,0.12)", background: "rgba(0,15,35,0.5)",
                    color: "#8ac0e8", fontSize: "13px", outline: "none"
                  }}
                />
              </div>
              <label style={{
                padding: "7px 14px", borderRadius: "7px", fontSize: "11px", fontWeight: "600",
                border: "1px solid rgba(0,200,100,0.2)", background: "rgba(0,120,60,0.12)",
                color: "#50cc88", cursor: "pointer", whiteSpace: "nowrap", display: "inline-flex", alignItems: "center", gap: "5px"
              }}>
                â†‘ Update Terms
                <input type="file" accept=".xlsx,.xls" style={{ display: "none" }} onChange={async (e) => {
                  const file = e.target.files?.[0];
                  if (!file) return;
                  try {
                    const buf = await file.arrayBuffer();
                    const zip = await parseZip(buf);
                    // Parse shared strings
                    const ssXml = zip["xl/sharedStrings.xml"] || "";
                    const ssMatches = [...ssXml.matchAll(/<si[^>]*>([\s\S]*?)<\/si>/g)];
                    const ss = ssMatches.map(m => {
                      const tMatches = [...m[1].matchAll(/<t[^>]*>([^<]*)<\/t>/g)];
                      return tMatches.map(t => t[1]).join("");
                    });
                    // Parse sheet
                    const sheetXml = zip["xl/worksheets/sheet1.xml"] || "";
                    const rowMatches = [...sheetXml.matchAll(/<row[^>]*>([\s\S]*?)<\/row>/g)];
                    const parseRows = rowMatches.map(rm => {
                      const cells = {};
                      const cellMatches = [...rm[1].matchAll(/<c\s+r="([A-Z]+)\d+"[^>]*(?:t="([^"]*)")?[^>]*>(?:[\s\S]*?<v>([^<]*)<\/v>)?[\s\S]*?<\/c>/g)];
                      cellMatches.forEach(cm => {
                        const col = cm[1], typ = cm[2], val = cm[3] || "";
                        cells[col] = typ === "s" ? (ss[parseInt(val)] || "") : val;
                      });
                      return cells;
                    });
                    if (parseRows.length < 2) { alert("No data found in spreadsheet"); return; }
                    // Find column mapping from headers
                    const hdrs = parseRows[0];
                    let colId="A",colName="B",colGrp="H",colCls="I",colK="K",colL="L",colM="M",colN="N",colO="O",colP="P",colQ="Q",colR="R";
                    for (const [c,v] of Object.entries(hdrs)) {
                      const lv = String(v).toLowerCase().replace(/[_\s.]+/g,"");
                      if (lv === "id" || lv === "acc") colId = c;
                      else if (lv === "name" || lv === "accname") colName = c;
                      else if (lv.includes("customergroup")) colGrp = c;
                      else if (lv.includes("class")) colCls = c;
                    }
                    const newRecords = [];
                    for (let i = 1; i < parseRows.length; i++) {
                      const r = parseRows[i];
                      const id = String(r[colId] || "").trim();
                      const nm = String(r[colName] || "").trim();
                      if (!id || !nm) continue;
                      const toNum = v => { try { const n = parseFloat(v); return isNaN(n) ? undefined : n; } catch { return undefined; } };
                      const rec = { id, name: nm };
                      const v1=toNum(r[colK]),v2=toNum(r[colL]),v3=toNum(r[colM]),v4=toNum(r[colN]),v5=toNum(r[colO]),v6=toNum(r[colP]);
                      if (v1!==undefined) rec.g1=v1; if (v2!==undefined) rec.g2=v2; if (v3!==undefined) rec.g3=v3;
                      if (v4!==undefined) rec.g3b_mpce=v4; if (v5!==undefined) rec.g3b_multi=v5; if (v6!==undefined) rec.g4=v6;
                      const nt = String(r[colQ]||"").trim() || String(r[colR]||"").trim();
                      if (nt) rec.other = nt;
                      const grp = String(r[colGrp]||"").trim();
                      const cls = String(r[colCls]||"").trim();
                      if (grp) rec.group = grp; if (cls) rec.cls = cls;
                      newRecords.push(rec);
                    }
                    if (newRecords.length === 0) { alert("No valid records found"); return; }
                    // Update CUSTOMER_TERMS_RAW
                    const oldCount = CUSTOMER_TERMS_RAW.length;
                    CUSTOMER_TERMS_RAW.length = 0;
                    newRecords.forEach(r => CUSTOMER_TERMS_RAW.push(r));
                    const added = newRecords.length - oldCount;
                    alert(`âœ“ Terms updated: ${newRecords.length} customers loaded${added > 0 ? ` (+${added} new)` : added < 0 ? ` (${added})` : ""}\n\nNote: This update is temporary for this session. The built-in data remains unchanged.`);
                    setTermsSearch(""); setTermsFilter("all"); setTermsVersion(v => v + 1);
                  } catch (err) { alert("Error reading spreadsheet: " + err.message); }
                  e.target.value = "";
                }} />
              </label>
              <div style={{ display: "flex", gap: "4px", flexWrap: "wrap" }}>
                {["all", "with_terms", "no_terms", "INSTALLER", "CONTRACTOR", "CONSULTANT", "WHOLESALER", "END USER", "F M", "OEM", "OTHER", "CAT 1", "CAT 2", "CAT 3", "CAT 3B - MPCE", "CAT 3B - Multi E", "CAT 4"].map(f => (
                  <button key={f} onClick={() => setTermsFilter(f)} style={{
                    padding: "5px 10px", borderRadius: "5px", fontSize: "10px", fontWeight: "500",
                    border: `1px solid ${termsFilter === f ? "rgba(0,140,255,0.3)" : "rgba(0,140,255,0.08)"}`,
                    background: termsFilter === f ? "rgba(0,80,150,0.15)" : "rgba(0,20,40,0.3)",
                    color: termsFilter === f ? "#70bbee" : "#4a7a9e",
                    cursor: "pointer", whiteSpace: "nowrap"
                  }}>{f === "all" ? "All" : f === "with_terms" ? "Has Terms" : f === "no_terms" ? "No Terms" : f}</button>
                ))}
              </div>
            </div>

            {/* Results count */}
            <div style={{ fontSize: "11px", color: "#3a6888", marginBottom: "10px" }}>
              Showing {termsResults.length} of {CUSTOMER_TERMS_RAW.length} customers
              {termsSearch && <span> matching "<strong style={{ color: "#70bbee" }}>{termsSearch}</strong>"</span>}
            </div>

            {/* Terms Table - horizontal scroll for mobile */}
            <div style={{
              borderRadius: "11px", overflow: "hidden",
              border: "1px solid rgba(0,140,255,0.08)",
              background: "rgba(0,15,30,0.4)", maxHeight: "65vh", overflowY: "auto",
              overflowX: "auto", WebkitOverflowScrolling: "touch"
            }}>
              <table style={{ minWidth: "900px", borderCollapse: "collapse", fontSize: "11px" }}>
                <thead>
                  <tr style={{
                    borderBottom: "1px solid rgba(0,140,255,0.1)",
                    position: "sticky", top: 0, background: "rgba(0,12,25,0.95)", zIndex: 2
                  }}>
                    {["Customer", "ID", "Group", "Class", "CAT 1", "CAT 2", "CAT 3", "CAT 3B - MPCE", "CAT 3B - Multi E", "CAT 4", "Notes"].map((h, i) => (
                      <th key={i} style={{
                        padding: "8px 7px", textAlign: i >= 4 && i <= 9 ? "center" : "left",
                        color: "#3a6888", fontWeight: "600", fontSize: "9px",
                        textTransform: "uppercase", letterSpacing: "0.5px", whiteSpace: "nowrap"
                      }}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {termsResults.map((c, idx) => {
                    const groups = getDiscountGroups(c);
                    const hasAny = Object.keys(groups).length > 0;
                    return (
                      <tr key={`${c.id}-${idx}`}
                        style={{ borderBottom: "1px solid rgba(0,140,255,0.04)" }}
                        onMouseEnter={(e) => e.currentTarget.style.background = "rgba(0,80,150,0.06)"}
                        onMouseLeave={(e) => e.currentTarget.style.background = "transparent"}>
                        <td style={{ padding: "7px 7px", color: "#8abbe8", fontWeight: "500", fontSize: "12px", maxWidth: "220px" }}>
                          {c.name}
                        </td>
                        <td style={{ padding: "7px 7px", color: "#3a6888", fontSize: "10px", fontFamily: "'Cascadia Code', 'Consolas', monospace" }}>
                          {c.id}
                        </td>
                        <td style={{ padding: "7px 5px", fontSize: "10px", color: 
                          c.group === "INSTALLER" ? "#70ccaa" : 
                          c.group === "CONTRACTOR" ? "#66bbdd" :
                          c.group === "WHOLESALER" ? "#8abbe8" : 
                          c.group === "CONSULTANT" ? "#bb99dd" :
                          c.group === "END USER" ? "#ddaa66" :
                          c.group === "F M" ? "#dd8899" :
                          c.group === "OEM" ? "#cccc66" :
                          c.group === "OTHER" ? "#ccaa55" : "#3a5060" }}>
                          {c.group || "â€”"}
                        </td>
                        <td style={{ padding: "7px 5px", fontSize: "11px", fontWeight: "600", textAlign: "center", color: c.cls ? "#8abbe8" : "#1e3040" }}>
                          {c.cls || "â€”"}
                        </td>
                        {["g1", "g2", "g3", "g3b_mpce", "g3b_multi", "g4"].map(gk => (
                          <td key={gk} style={{
                            padding: "7px 5px", textAlign: "center",
                            color: c[gk] != null ? "#70ccaa" : "#1e3040",
                            fontWeight: c[gk] != null ? "600" : "400",
                            fontSize: "12px"
                          }}>
                            {c[gk] != null ? `${c[gk]}%` : "â€”"}
                          </td>
                        ))}
                        <td style={{
                          padding: "7px 7px", color: c.other ? "#ccaa55" : "#1e3040",
                          fontSize: "10px", maxWidth: "180px", overflow: "hidden",
                          textOverflow: "ellipsis", whiteSpace: "nowrap"
                        }} title={c.other || ""}>
                          {c.other || "â€”"}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              {termsResults.length === 0 && (
                <div style={{ padding: "30px", textAlign: "center", color: "#3a5a78", fontSize: "12px" }}>
                  No customers match your search
                </div>
              )}
            </div>

            {/* Stats summary */}
            <div style={{
              marginTop: "14px", padding: "10px 14px", borderRadius: "9px",
              background: "rgba(0,15,30,0.3)", border: "1px solid rgba(0,140,255,0.05)",
              display: "flex", gap: "16px", flexWrap: "wrap", fontSize: "10px", color: "#3a6888"
            }}>
              <span>Total: <strong style={{ color: "#6a9abb" }}>{CUSTOMER_TERMS_RAW.length}</strong></span>
              <span>With terms: <strong style={{ color: "#40aa70" }}>{CUSTOMER_TERMS_RAW.filter(c => Object.keys(getDiscountGroups(c)).length > 0).length}</strong></span>
              <span>No terms: <strong style={{ color: "#aa7744" }}>{CUSTOMER_TERMS_RAW.filter(c => Object.keys(getDiscountGroups(c)).length === 0).length}</strong></span>
              <span>With notes: <strong style={{ color: "#ccaa55" }}>{CUSTOMER_TERMS_RAW.filter(c => c.other).length}</strong></span>
            </div>
          </div>
        )}
      </div>

      <style>{`
        @keyframes spin { to { transform: rotate(360deg); } }
        /* JetBrains Mono loaded via system fallback */
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,140,255,0.12); border-radius: 3px; }
      `}</style>
    </div>
  );
}

// â”€â”€â”€ SHARED STYLES â”€â”€â”€
const btnStyle = {
  padding: "8px 14px", borderRadius: "7px",
  border: "1px solid rgba(0,140,255,0.15)", background: "rgba(0,30,55,0.4)",
  color: "#6a9abb", fontSize: "12px", cursor: "pointer"
};

const choiceBtnStyle = (color) => ({
  padding: "2px 7px", borderRadius: "4px", fontSize: "9px", fontWeight: "600",
  border: `1px solid ${color}33`, background: `${color}15`,
  color, cursor: "pointer"
});

const valColors = {
  match: { bg: "rgba(0,180,80,0.1)", border: "rgba(0,180,80,0.2)", text: "#40cc80" },
  mismatch: { bg: "rgba(255,120,30,0.1)", border: "rgba(255,120,30,0.2)", text: "#ee8833" },
  missing: { bg: "rgba(200,180,50,0.08)", border: "rgba(200,180,50,0.15)", text: "#bbaa44" },
  missing_with_terms: { bg: "rgba(100,140,255,0.08)", border: "rgba(100,140,255,0.15)", text: "#7799ee" },
  no_terms: { bg: "rgba(100,100,140,0.08)", border: "rgba(100,100,140,0.15)", text: "#7777aa" },
};


const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(PCFTool));
</script>
</body>
</html>